<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title id="pageTitle">JMusic Player</title>

        <script src="/js/theme-initializer.js"></script>

        <!-- Bulma CSS -->
        <link rel="stylesheet" href="/css/bulma.min.css"/>
        <link rel="stylesheet" href="https://unpkg.com/primeicons@7.0.0/primeicons.css">
        <link rel="stylesheet" href="/css/custom.css"/>
        <link rel="stylesheet" href="/css/playback-bar.css"/>
        <link rel="stylesheet" href="/css/player.css"/>

        <!-- HTMX -->
        <script src="/js/htmx.min.js"></script>

        <link id="favicon" rel="icon" type="image/x-icon" href="logo.png">
    </head>
    <body>

        <div id="contextMenu" class="context-menu">
            <ul>
                <li id="contextAddToPlaylist">
                    <i class="pi pi-list"></i>
                    <span>Add to Playlist</span>
                </li>
                <li id="contextViewLyrics">
                    <i class="pi pi-file-alt"></i>
                    <span>View Lyrics</span>
                </li>
            </ul>
        </div>

        <div id="whisperConfirmModal" class="modal">
            <div class="modal-background"></div>
            <div class="modal-content">
                <div class="box">
                    <div id="whisperWarning" class="notification is-danger is-hidden">
                        <p>Whisper is not installed. Please install it to generate lyrics.</p>
                        <p class="is-size-7">This can be done from the Import page.</p>
                    </div>
                    <p>Generating lyrics will use the local Whisper model.</p>
                    <div class="field mt-4">
                        <label class="label">Select Model:</label>
                        <div class="control">
                            <label class="radio">
                                <input type="radio" name="whisperModel" value="tiny" checked>
                                Tiny (~1GB VRAM)
                            </label>
                            <br>
                            <label class="radio">
                                <input type="radio" name="whisperModel" value="base">
                                Base (~1GB VRAM)
                            </label>
                            <br>
                            <label class="radio">
                                <input type="radio" name="whisperModel" value="small">
                                Small (~2GB VRAM)
                            </label>
                            <br>
                            <label class="radio">
                                <input type="radio" name="whisperModel" value="medium">
                                Medium (~5GB VRAM)
                            </label>
                            <br>
                            <label class="radio">
                                <input type="radio" name="whisperModel" value="large">
                                Large (~10GB VRAM)
                            </label>
                        </div>
                    </div>
                    <div class="field mt-4">
                        <label class="label">Specialized Models:</label>
                        <div class="control">
                            <label class="radio">
                                <input type="radio" name="whisperModel" value="turbo">
                                Turbo (English only, ~6GB VRAM)
                            </label>
                        </div>
                    </div>
                    <p class="is-size-7 mt-3">Note: The first time running a model, it will take a while to download.</p>
                    <p class="mt-3">Do you want to proceed?</p>
                    <div class="buttons is-centered mt-5">
                        <button id="whisperConfirmOk" class="button is-primary">OK</button>
                        <button id="whisperConfirmCancel" class="button">Cancel</button>
                    </div>
                </div>
            </div>
        </div>

        <audio id="audioPlayer" preload="metadata"></audio>

        <!-- Hero layout -->
        <section class="hero is-fullheight">

            <!-- Hero Head (Navbar) -->
            <div class="hero-head">
                <nav class="navbar" role="navigation">
                    <div class="navbar-brand">
                        <a class="navbar-item" href="/index.html"><strong>JMusic</strong></a>
                        <a role="button" class="navbar-item" id="themeToggle">
                            <i class="pi pi-sun" id="themeIcon"></i>
                        </a>
                        <a role="button" class="navbar-item" id="playerToggle">
                            <i class="pi pi-expand" id="playerIcon"></i>
                        </a>
                    </div>
                    <div id="playerNavMenu" class="navbar-menu">
                        <div class="navbar-start">
                        </div>
                        <div class="navbar-item is-expanded" style="justify-content: center;">
                            <div class="navbar-search-container">
                                <div class="control has-icons-right" style="flex-grow: 1;">
                                    <input class="input is-rounded" type="text" placeholder="Search all songs..." name="search" id="globalSearchInput" onkeydown="if (event.key === 'Enter') { window.location.href = '/index.html?q=' + encodeURIComponent(this.value); }">
                                    <span class="icon is-small is-right is-clickable" id="clearSearchIcon" style="pointer-events: auto;">
                                        <i class="pi pi-times"></i>
                                    </span>
                                </div>
                                <div id="globalSearchDropdown" class="dropdown-menu" role="menu" style="display: none;">
                                    <div id="globalSearchDropdownLoadingIndicator" class="htmx-indicator has-text-centered py-2">
                                        <i class="pi pi-spin pi-spinner" style="font-size: 1.5rem;"></i>
                                    </div>
                                    <div class="dropdown-content"
                                         hx-post="/api/music/ui/search-suggestions"
                                         hx-trigger="keyup changed delay:300ms from:#globalSearchInput"
                                         hx-vals="js:{searchQuery: document.getElementById('globalSearchInput').value}"
                                         hx-target="this"
                                         hx-swap="innerHTML"
                                         hx-indicator="#globalSearchDropdownLoadingIndicator">
                                        <!-- Suggestions will be loaded here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="navbar-end">
                        </div>
                    </div>
                </nav>
            </div>

            <!-- Hero Body (Main content area for fullscreen player) -->
            <div class="hero-body m-0 p-0">
                <div id="mainContent" class="fullscreen-player-content">
                    <div id="lyricsContainer" class="lyrics-container">
                        <button id="closeLyricsBtn" class="delete is-large"></button>
                        <div id="lyricsContent" class="lyrics-content"></div>
                        <button id="generateLyricsBtn" class="button is-small is-primary" style="display: none;">
                            <span id="generateLyricsButtonText">Generate Lyrics</span>
                        </button>
                    </div>
                    <div class="song-cover-row">
                        <img id="prevSongCoverImage" src="/logo.png" alt="Previous Song Cover" class="side-song-cover">
                        <div class="song-cover-wrapper">
                            <img id="songCoverImage" src="/logo.png" alt="Song Cover" class="main-song-cover">
                        </div>
                        <img id="nextSongCoverImage" src="/logo.png" alt="Next Song Cover" class="side-song-cover">
                    </div>
                    <div class="song-details">
                        <p id="songTitle" class="title has-text-white">Loading...</p>
                        <p id="songArtist" class="artist">Unknown Artist</p>
                    </div>



                    <!-- Music controls will be dynamically loaded or managed here -->

                    <!-- CENTER: Controls + Progress -->
                    <div class="level-item has-text-centered is-flex is-flex-direction-column is-align-items-center" style="width: 100%; flex-grow: 1; flex-shrink: 1;">
                        <!-- Playback buttons -->
                        <div class="buttons are-large mb-2">
                            <button id="shuffleBtn" title="Shuffle"><i id="shuffleIcon" class="pi pi-sort-alt"></i></button>
                            <button id="prevBtn"  title="Previous"><i class="pi pi-step-backward"></i></button>
                            <button id="playPauseBtn"  title="Play/Pause"><i id="playPauseIcon" class="pi pi-play"></i></button>
                            <button id="nextBtn"   title="Next"><i id="nextIcon" class="pi pi-step-forward"></i></button>
                            <button id="repeatBtn"   title="Repeat"><i id="repeatIcon" class="pi pi-refresh"></i></button>
                        </div>

                        <!-- Progress bar and Volume Control -->
                        <div class="is-flex is-align-items-center is-justify-content-center playback-progress-volume-container" style="width: 100%;">
                            <!-- Progress bar -->
                            <div class="is-flex is-align-items-center is-justify-content-center" style="width: 100%;">
                                <span id="currentTime" class="has-text-success has-text-weight-semibold is-size-4 mr-2">0:00</span>
                                <input type="range" min="0" max="100" value="0"
                                       style="width:100%"
                                       name="seconds" id="playbackProgressBar"/>
                                <span id="totalTime" class="has-text-success has-text-weight-semibold is-size-4 ml-2">0:00</span>
                            </div>

                            <!-- Volume Control (hidden on mobile) -->
                            <div id="toggledVBar">
                                <div class="is-flex is-align-items-center is-hidden-mobile ml-4 is-vertical-volume">
                                    <i class="pi pi-volume-up has-text-white"></i>
                                    <input type="range" min="0" max="100" value="80" name="level" id="volumeProgressBar"/>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>  
        </section>

        <script src="/js/musicBar.js"></script>
        <script src="/js/mediaSession.js"></script>
        <script src="/js/navbar.js"></script>
        <script src="/js/songQueue.js"></script>
        <script>
            function getLyricsAction() {
                console.log('getLyricsAction called.');
                console.log('  musicState.hasLyrics:', window.musicState.hasLyrics);
                console.log('  musicState.currentSongId:', window.musicState.currentSongId);
                if (window.musicState && window.musicState.hasLyrics && window.musicState.currentSongId) {
                    return `/api/song/${window.musicState.currentSongId}/lyrics`;
                }
                return '#no-lyrics'; // Special string to indicate no lyrics
            }

            function getAddToPlaylistDialogAction() {
                if (musicState.currentSongId) {
                    return `/api/music/ui/add-to-playlist-dialog/${musicState.currentSongId}`;
                }
                return '#'; // No action if no song
            }

            function generateLyricsAction(selectedModel) {
                if (musicState.currentSongId) {
                    return `/api/song/${musicState.currentSongId}/generate-lyrics?model=${selectedModel}`;
                }
                return '#';
            }

            document.addEventListener('DOMContentLoaded', function() {
                const songCoverImage = document.getElementById('songCoverImage');
                const contextMenu = document.getElementById('contextMenu');
                const contextAddToPlaylist = document.getElementById('contextAddToPlaylist');
                const contextViewLyrics = document.getElementById('contextViewLyrics');

                const mainContent = document.getElementById('mainContent');
                const lyricsContainer = document.getElementById('lyricsContainer');
                const lyricsContent = document.getElementById('lyricsContent');
                const closeLyricsBtn = document.getElementById('closeLyricsBtn');
                const generateLyricsBtn = document.getElementById('generateLyricsBtn');

                const whisperConfirmModal = document.getElementById('whisperConfirmModal');
                const whisperConfirmOk = document.getElementById('whisperConfirmOk');
                const whisperConfirmCancel = document.getElementById('whisperConfirmCancel');

                songCoverImage.addEventListener('contextmenu', function(event) {
                    event.preventDefault();
                    contextMenu.style.display = 'block';
                    contextMenu.style.left = event.pageX + 'px';
                    contextMenu.style.top = event.pageY + 'px';
                });

                document.addEventListener('click', function(event) {
                    if (!contextMenu.contains(event.target)) {
                        contextMenu.style.display = 'none';
                    }
                });

                contextAddToPlaylist.addEventListener('click', function() {
                    const url = getAddToPlaylistDialogAction();
                    if (url !== '#') {
                        htmx.ajax('GET', url, {
                            target: '#addToPlaylistModalContent',
                            swap: 'innerHTML'
                        }).then(() => {
                            document.getElementById('addToPlaylistModal').classList.add('is-active');
                        });
                    }
                    contextMenu.style.display = 'none';
                });

                contextViewLyrics.addEventListener('click', function() {
                    console.log('contextViewLyrics clicked. Current musicState:', window.musicState);
                    const url = getLyricsAction();
                    if (url === '#no-lyrics') {
                        console.log('getLyricsAction returned #no-lyrics. Displaying "No lyrics found" message.');
                        lyricsContent.innerText = 'No lyrics found for this song.';
                        generateLyricsBtn.style.display = 'block';
                        mainContent.classList.add('lyrics-view-active');
                    } else if (url !== '#') {
                        console.log('getLyricsAction returned URL:', url, '. Attempting to fetch lyrics using native fetch.');
                        generateLyricsBtn.style.display = 'none'; // Hide generate button if lyrics are found
                        
                        // Use native fetch API instead of htmx.ajax for direct text response handling
                        fetch(url)
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error(`HTTP error! status: ${response.status}`);
                                }
                                console.log('GET /api/song/{id}/lyrics raw fetch response:', response);
                                return response.text();
                            })
                            .then(textData => {
                                console.log('Lyrics fetched (GET) textData:', textData);
                                console.log('Lyrics fetched (GET) textData type:', typeof textData);
                                lyricsContent.innerText = textData;
                                mainContent.classList.add('lyrics-view-active');
                            })
                            .catch(error => {
                                console.error('Error fetching lyrics:', error);
                                lyricsContent.innerText = 'Error loading lyrics.';
                                mainContent.classList.add('lyrics-view-active'); // Still show container, but with error
                            });
                    }
                    contextMenu.style.display = 'none';
                });
                
                closeLyricsBtn.addEventListener('click', function() {
                    mainContent.classList.remove('lyrics-view-active');
                });

                generateLyricsBtn.addEventListener('click', function() {
                    const whisperWarning = document.getElementById('whisperWarning');
                    if (window.whisperInstalled === false) {
                        whisperWarning.classList.remove('is-hidden');
                    } else {
                        whisperWarning.classList.add('is-hidden');
                    }
                    whisperConfirmModal.classList.add('is-active');
                });

                whisperConfirmOk.addEventListener('click', function() {
                    whisperConfirmModal.classList.remove('is-active');

                    const selectedModel = document.querySelector('input[name="whisperModel"]:checked').value;
                    const url = generateLyricsAction(selectedModel);
                    if (url === '#')
                        return;

                    const originalButtonText = generateLyricsButtonText.innerText; // Store original text
                    generateLyricsBtn.classList.add('is-loading');
                    generateLyricsBtn.disabled = true;
                    generateLyricsButtonText.innerText = 'Generating lyrics...'; // Update button text
                    lyricsContent.innerText = 'Generating lyrics...'; // Update lyrics display area

                    htmx.ajax('POST', url, {
                        swap: 'none'
                    }).finally(() => {
                        generateLyricsBtn.classList.remove('is-loading');
                        generateLyricsBtn.disabled = false;
                        generateLyricsButtonText.innerText = originalButtonText; // Restore original text
                    });
                });

                generateLyricsBtn.addEventListener('htmx:afterRequest', function(event) {
                    if (event.detail.successful && event.detail.xhr.status === 200) {
                        lyricsContent.innerText = event.detail.xhr.responseText;
                        window.musicState.hasLyrics = true;
                        generateLyricsBtn.style.display = 'none';
                        mainContent.classList.add('lyrics-view-active'); // Show the lyrics container
                    } else {
                        lyricsContent.innerText = 'Failed to generate lyrics. Please try again.';
                    }
                });

                whisperConfirmCancel.addEventListener('click', function() {
                    whisperConfirmModal.classList.remove('is-active');
                });

                // Functions for global search dropdown
                function setupGlobalSearchListeners() {
                    // The clear button listener will now be delegated to document.body
                    // No need to attach directly here anymore.
                }

                function handleClearGlobalSearch() {
                    const globalSearchInput = document.getElementById('globalSearchInput');
                    const globalSearchDropdown = document.getElementById('globalSearchDropdown');

                    if (globalSearchInput) {
                        globalSearchInput.value = '';
                        if (globalSearchDropdown) {
                            globalSearchDropdown.style.display = 'none';
                        }
                    }
                }

                // Define showDropdown and hideDropdown
                function showDropdown() {
                    const globalSearchInput = document.getElementById('globalSearchInput');
                    const globalSearchDropdown = document.getElementById('globalSearchDropdown');

                    if (globalSearchInput.value.trim() !== '' && globalSearchDropdown) {
                        globalSearchDropdown.style.display = 'block';
                        // Trigger HTMX for suggestions here
                        htmx.trigger(globalSearchDropdown.querySelector('.dropdown-content'), 'keyup changed');
                    } else if (globalSearchDropdown) {
                        globalSearchDropdown.style.display = 'none';
                    }
                }

                function hideDropdown() {
                    const globalSearchInput = document.getElementById('globalSearchInput');
                    const globalSearchDropdown = document.getElementById('globalSearchDropdown');

                    setTimeout(() => {
                        if (globalSearchDropdown && !globalSearchInput.matches(':focus')) {
                            globalSearchDropdown.style.display = 'none';
                        }
                    }, 100);
                }

                // Initial setup and event listeners for global search
                const globalSearchInput = document.getElementById('globalSearchInput');
                const globalSearchDropdown = document.getElementById('globalSearchDropdown');

                if (globalSearchInput && globalSearchDropdown) {
                    globalSearchInput.addEventListener('focus', showDropdown);
                    globalSearchInput.addEventListener('keyup', showDropdown);
                    globalSearchInput.addEventListener('blur', hideDropdown);

                    globalSearchDropdown.addEventListener('mousedown', (event) => {
                        event.preventDefault();
                    });
                }

                // Delegated event listener for clearSearchIcon
                document.body.addEventListener('click', function (event) {
                    if (event.target.closest('#clearSearchIcon')) {
                        handleClearGlobalSearch();
                    }
                });

                // HTMX afterSwap listener for dropdown content
                document.body.addEventListener('htmx:afterSwap', function (event) {
                    if (event.detail.target.closest('#globalSearchDropdown .dropdown-content')) {
                        // If the dropdown content was swapped, re-evaluate its visibility
                        showDropdown();
                    }
                });
            });
        </script>
    </body>
</html>