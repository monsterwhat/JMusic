<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title id="pageTitle">JMusic Settings</title>

        <script src="/js/theme-initializer.js"></script>

        <!-- Bulma CSS -->
        <link rel="stylesheet" href="/css/bulma.min.css"/>
        <link rel="stylesheet" href="https://unpkg.com/primeicons@7.0.0/primeicons.css">
        <link rel="stylesheet" href="/css/custom.css"/>
        <link rel="stylesheet" href="/css/playback-bar.css"/>

        <!-- HTMX -->
        <script src="/js/htmx.min.js"></script>

        <link id="favicon" rel="icon" type="image/x-icon" href="logo.png">

        <style>
            html, body {
                height: 100%;
                background-color: #222;
            }

            body {
                display: flex;
                flex-direction: column;
            }

            .content-wrapper {
                flex-grow: 1;
                overflow: auto;
            }

            #logsPanel::-webkit-scrollbar {
                width: 6px;
            }
            #logsPanel::-webkit-scrollbar-thumb {
                background: #888;
                border-radius: 3px;
            }
            #logsPanel::-webkit-scrollbar-thumb:hover {
                background: #aaa;
            }
        </style>
    </head>
    <body>

        <audio id="audioPlayer" preload="metadata"></audio> 

        <section class="hero is-fullheight">

            <!-- Hero Head (Navbar) -->
            <div class="hero-head">
                <nav class="navbar" role="navigation">
                    <div class="navbar-brand">
                        <a class="navbar-item" href="/index.html"><span class="icon"><i class="pi pi-home"></i></span><strong>JMusic</strong></a>
                        <a role="button" class="navbar-item" id="themeToggle">
                            <i class="pi pi-sun" id="themeIcon"></i>
                        </a>
                        <a role="button" class="navbar-item" id="playerToggle">
                            <i class="pi pi-expand" id="playerIcon"></i>
                        </a>
                        <a role="button" class="navbar-burger" aria-label="menu" aria-expanded="false" data-target="navMenu">
                            <span aria-hidden="true"></span>
                            <span aria-hidden="true"></span>
                            <span aria-hidden="true"></span>
                        </a>
                        <a role="button" class="navbar-item is-hidden-desktop is-hidden-mobile" id="sidebarToggle">
                            <i class="pi pi-bars"></i>
                        </a>
                    </div>
                    <div id="navMenu" class="navbar-menu">
                        <div class="navbar-start">
                        </div>
                        <div class="navbar-item is-expanded" style="justify-content: center;">
                            <div class="navbar-search-container">
                                <div class="control has-icons-right" style="flex-grow: 1;">
                                    <input class="input is-rounded" type="text" placeholder="Search all songs..." name="search" id="globalSearchInput"
                                           hx-get="/api/music/ui/search-results"
                                           hx-trigger="keyup changed delay:500ms, search"
                                           hx-target="#searchResultsContainer"
                                           hx-swap="innerHTML"
                                           hx-include="[name='search']"
                                           hx-indicator="#loadingRow">
                                    <span class="icon is-small is-right is-clickable" id="clearSearchIcon" style="pointer-events: auto;">
                                        <i class="pi pi-times"></i>
                                    </span>
                                </div>
                                <div id="globalSearchDropdown" class="dropdown-menu" role="menu" style="display: none;">
                                    <div id="globalSearchDropdownLoadingIndicator" class="htmx-indicator has-text-centered py-2">
                                        <i class="pi pi-spin pi-spinner" style="font-size: 1.5rem;"></i>
                                    </div>
                                    <div class="dropdown-content"
                                         hx-post="/api/music/ui/search-suggestions"
                                         hx-trigger="keyup changed delay:300ms from:#globalSearchInput"
                                         hx-vals="js:{searchQuery: document.getElementById('globalSearchInput').value}"
                                         hx-target="this"
                                         hx-swap="innerHTML"
                                         hx-indicator="#globalSearchDropdownLoadingIndicator">
                                        <!-- Suggestions will be loaded here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="navbar-end">
                            <a class="navbar-item" id="openProfileModalBtn">
                                <span class="icon"><i class="pi pi-user"></i></span>
                                <span id="currentProfileName">Loading...</span>
                            </a>
 
                            <a class="navbar-item" href="/settings.html">
                                <span class="icon"><i class="pi pi-cog"></i></span>
                                <span>Settings</span>
                            </a>
                            <a class="navbar-item" href="/import.html">
                                <span class="icon"><i class="pi pi-download"></i></span>
                                <span>Import</span>
                            </a>
                        </div>
                    </div>
                </nav>
            </div>

            <!-- Hero Body (Main content area) -->
            <div class="hero-body m-0 p-0" style="display: block;">
                <div id="mainContent" class="columns p-0 m-0" style="width:100%;">
                    <!-- Settings Content -->
                    <div class="content-wrapper" style="height: calc(100vh - 200px);">
                        <section class="section">
                            <div class="container">
                                <h1 class="title has-text-white">Settings</h1>
                                <div class="columns is-multiline">

                                    <!-- Library Management Card -->
                                    <div class="column is-one-third">
                                        <div class="card has-background-grey-darker has-text-white">
                                            <header class="card-header">
                                                <p class="card-header-title has-text-white">
                                                    Library Management
                                                </p>
                                                <button class="card-header-icon" aria-label="more options" id="toggleLibraryManagementBtn">
                                                    <span class="icon">
                                                        <i class="pi pi-angle-down" aria-hidden="true"></i>
                                                    </span>
                                                </button>
                                            </header>
                                            <div class="card-content" id="libraryManagementContent">
                                                <div class="field">
                                                    <label class="label has-text-white">Music Library Folder</label>
                                                    <div class="control has-addons">
                                                        <input id="musicLibraryPathInput" name="musicLibraryPathInput" class="input has-background-grey-darker has-text-white is-expanded" type="text" placeholder="Select music library folder" value="(not set)">
                                                        <button id="browseMusicFolderBtn" class="button is-info">Browse</button>
                                                    </div>
                                                </div>
                                                <div class="buttons mt-3">
                                                    <button id="saveMusicLibraryPathBtn" class="button is-success"
                                                            hx-post="/api/settings/music-library-path"
                                                            hx-include="#musicLibraryPathInput"
                                                            hx-swap="none">Save Path</button>
                                                </div>
                                                <div class="buttons">
                                                    <button id="resetLibrary" class="button is-link">Reset to Default</button>
                                                    <button id="scanLibrary" class="button is-primary">Scan Library</button>
                                                    <button id="reloadMetadata" class="button is-info">Reload All Metadata</button>
                                                    <button id="deleteDuplicates" class="button is-warning">Delete Duplicates</button>
                                                </div>
                                                <div class="field mt-5">
                                                    <label class="switch is-info">
                                                        <input id="runAsServiceToggle" type="checkbox" name="runAsServiceToggle"
                                                               hx-post="/api/settings/toggle-run-as-service"
                                                               hx-trigger="change"
                                                               hx-swap="none">
                                                        <span class="check"></span>
                                                        <span class="control-label has-text-white">Run as Service</span>
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Video Library Management Card -->
                                    <div class="column is-one-third">
                                        <div class="card has-background-grey-darker has-text-white">
                                            <header class="card-header">
                                                <p class="card-header-title has-text-white">
                                                    Video Library Management
                                                </p>
                                                <button class="card-header-icon" aria-label="more options" id="toggleVideoLibraryManagementBtn">
                                                    <span class="icon">
                                                        <i class="pi pi-angle-down" aria-hidden="true"></i>
                                                    </span>
                                                </button>
                                            </header>
                                            <div class="card-content" id="videoLibraryManagementContent">
                                                <div class="field">
                                                    <label class="label has-text-white">Video Library Folder</label>
                                                    <div class="control has-addons">
                                                        <input id="videoLibraryPathInput" name="videoLibraryPathInput" class="input has-background-grey-darker has-text-white is-expanded" type="text" placeholder="Select video library folder" value="(not set)">
                                                        <button id="browseVideoFolderBtn" class="button is-info">Browse</button>
                                                    </div>
                                                </div>
                                                <div class="buttons mt-3">
                                                    <button id="saveVideoLibraryPathBtn" class="button is-success"
                                                            hx-post="/api/settings/video-library-path"
                                                            hx-include="#videoLibraryPathInput"
                                                            hx-swap="none">Save Path</button>
                                                </div>
                                                <div class="buttons">
                                                    <button id="scanVideoLibrary" class="button is-primary"
                                                            hx-post="/api/video/scan"
                                                            hx-trigger="click"
                                                            hx-swap="none">Scan Video Library</button>
                                                    <button id="reloadVideoMetadata" class="button is-info"
                                                            hx-post="/api/video/reload-metadata"
                                                            hx-trigger="click"
                                                            hx-swap="none">Reload All Metadata</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Import Settings Card -->
                                    <div class="column is-one-third is-hidden" id="importSettingsCardColumn">
                                        <div class="card has-background-grey-darker has-text-white" id="importSettingsCard">
                                            <header class="card-header">
                                                <p class="card-header-title has-text-white">
                                                    Import Settings
                                                </p>
                                                <button class="card-header-icon" aria-label="more options" id="toggleImportSettingsBtn">
                                                    <span class="icon">
                                                        <i class="pi pi-angle-down" aria-hidden="true"></i>
                                                    </span>
                                                </button>
                                            </header>
                                            <div class="card-content" id="importSettingsContent">
                                                <div class="field">
                                                    <label class="label has-text-white" for="outputFormat">Output Format</label>
                                                    <div class="control">
                                                        <div class="select is-fullwidth">
                                                            <select id="outputFormat">
                                                                <option value="mp3">MP3</option>
                                                                <option value="flac">FLAC</option>
                                                                <option value="ogg">OGG</option>
                                                                <option value="opus">OPUS</option>
                                                                <option value="m4a">M4A</option>
                                                                <option value="wav">WAV</option>
                                                            </select>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="columns">
                                                    <div class="column">
                                                        <div class="field">
                                                            <label class="label has-text-white" for="downloadThreads">Download Threads</label>
                                                            <div class="control">
                                                                <input class="input" type="number" id="downloadThreads" value="4" min="1">
                                                            </div>
                                                        </div> 
                                                    </div>
                                                    <div class="column">
                                                        <div class="field">
                                                            <label class="label has-text-white" for="searchThreads">Search Threads</label>
                                                            <div class="control">
                                                                <input class="input" type="number" id="searchThreads" value="4" min="1">
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="buttons mt-3">
                                                    <button id="saveImportSettingsBtn" class="button is-success is-fullwidth">Save</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Logs Card -->
                                    <div class="column is-one-third">
                                        <div class="card has-background-grey-darker has-text-white">
                                            <header class="card-header">
                                                <p class="card-header-title has-text-white">
                                                    Logs
                                                </p>
                                                <button class="card-header-icon" aria-label="more options" id="toggleLogsBtn">
                                                    <span class="icon">
                                                        <i class="pi pi-angle-down" aria-hidden="true"></i>
                                                    </span>
                                                </button>
                                            </header>
                                            <div class="card-content" id="logsCardContent">
                                                <div style="max-height: 200px; overflow-y: auto;" id="logsPanel">
                                                    <!-- JS will populate logs here -->
                                                </div>
                                                <div class="buttons mt-3">
                                                    <button id="clearLogs" class="button is-danger">Clear Logs</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div> 

                                    <!-- Data Management Card -->
                                    <div class="column is-one-third">
                                        <div class="card has-background-grey-darker has-text-white">
                                            <header class="card-header">
                                                <p class="card-header-title has-text-white">
                                                    Data Management
                                                </p>
                                                <button class="card-header-icon" aria-label="more options" id="toggleDataManagementBtn">
                                                    <span class="icon">
                                                        <i class="pi pi-angle-down" aria-hidden="true"></i>
                                                    </span>
                                                </button>
                                            </header>
                                            <div class="card-content" id="dataManagementContent">
                                                <p class="subtitle has-text-white">Manage application data.</p>
                                                <div class="buttons">
                                                    <button id="clearSongs" class="button is-warning">Clear Songs DB</button>
                                                    <button id="clearPlaybackHistory" hx-post="/api/settings/clearPlaybackHistory" class="button is-danger">Clear Playback History</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>


                                </div>
                            </div>
                        </section>
                    </div> 
                </div>
            </div>

            <!-- Hero Foot (Music Bar) -->
            <div class="hero-foot card has-background-grey-darker has-text-white m-3 p-3">
                <nav class="level is-mobile">

                    <!-- LEFT: Song Info -->
                    <div class="level-left is-hidden-mobile">
                        <div class="level-item">
                            <div class="image-container mr-3">
                                <figure class="image is-96x96">
                                    <img id="songCoverImage" src="/logo.png" alt="Song Cover">
                                </figure>
                                <button id="expandImageBtn">
                                    <span class="icon is-small"><i class="pi pi-expand"></i></span>
                                </button>
                            </div>
                            <div>
                                <p id="songTitle" class="has-text-white has-text-weight-semibold is-size-6">Loading...</p>
                                <p id="songArtist" class="has-text-success is-size-7">Unknown Artist</p>
                            </div>
                        </div>
                    </div>

                    <!-- CENTER: Controls + Progress -->
                    <div class="level-item has-text-centered is-flex is-flex-direction-column is-align-items-center" style="width: 100%; flex-grow: 1; flex-shrink: 1;">
                        <!-- Playback buttons -->
                        <div class="buttons are-small mb-2">
                            <button id="shuffleBtn" title="Shuffle"><i id="shuffleIcon" class="pi pi-sort-alt"></i></button>
                            <button id="prevBtn"  title="Previous"><i class="pi pi-step-backward"></i></button>
                            <button id="playPauseBtn"  title="Play/Pause"><i id="playPauseIcon" class="pi pi-play"></i></button>
                            <button id="nextBtn"   title="Next"><i id="nextIcon" class="pi pi-step-forward"></i></button>
                            <button id="repeatBtn"   title="Repeat"><i id="repeatIcon" class="pi pi-refresh"></i></button>
                        </div>

                        <!-- Progress bar -->
                        <div class="is-flex is-align-items-center is-justify-content-center" style="width: 100%;">
                            <span id="currentTime" class="has-text-success has-text-weight-semibold is-size-6 mr-2">0:00</span>
                            <input type="range" min="0" max="100" value="0"
                                   style="width:100%"
                                   name="seconds" id="playbackProgressBar"/>
                            <span id="totalTime" class="has-text-success has-text-weight-semibold is-size-6 ml-2">0:00</span>
                        </div>

                        <!-- Song Info for mobile -->
                        <div class="is-hidden-desktop mt-2" style="width: 100%;">
                            <div style="overflow: hidden;">
                                <p id="songTitleMobile" class="has-text-white has-text-weight-semibold is-size-6 marquee">Loading...</p>
                            </div>
                            <div style="overflow: hidden;">
                                <p id="songArtistMobile" class="has-text-success is-size-7 marquee">Unknown Artist</p>
                            </div>
                        </div>
                    </div>

                    <!-- RIGHT: Volume -->
                    <div class="level-right is-hidden-mobile">
                        <div class="level-item">
                            <div class="is-flex is-align-items-center">
                                <i class="pi pi-volume-up has-text-white mr-2"></i>
                                <input type="range" min="0" max="100" value="80" name="level" id="volumeProgressBar"/>
                            </div>
                        </div>
                    </div> 
                </nav>
            </div>

        </section>

        <script src="/js/musicBar.js"></script>
        <script src="/js/mediaSession.js"></script>
        <script src="/js/settings.js"></script>
        <script src="/js/video-settings.js"></script>
        <script src="/js/navbar.js"></script>
        <script src="/js/profileManager.js"></script>

        <script>
            document.addEventListener('DOMContentLoaded', async () => {
                const importSettingsCardColumn = document.getElementById('importSettingsCardColumn');
                if (importSettingsCardColumn) {
                    try {
                        const response = await fetch('/api/settings/import-capability');
                        const data = await response.json();
                        if (response.ok && data.data === true) {
                            importSettingsCardColumn.classList.remove('is-hidden');
                        }
                    } catch (error) {
                        console.error('Failed to fetch import capability status:', error);
                    }
                }

                // --- Start of copied global search logic ---
                const globalSearchInput = document.querySelector('input[name="search"]');
                const globalSearchDropdown = document.getElementById('globalSearchDropdown');

                function showDropdown() {
                    if (globalSearchInput.value.trim() !== '' && globalSearchDropdown.querySelector('.dropdown-item, .htmx-indicator')) {
                        globalSearchDropdown.style.display = 'block';
                    } else {
                        globalSearchDropdown.style.display = 'none';
                    }
                }

                function hideDropdown() {
                    setTimeout(() => {
                        if (!globalSearchInput.matches(':focus')) {
                            globalSearchDropdown.style.display = 'none';
                        }
                    }, 100);
                }

                if (globalSearchInput && globalSearchDropdown) {
                    globalSearchInput.addEventListener('focus', showDropdown);
                    globalSearchInput.addEventListener('keyup', showDropdown);
                    globalSearchInput.addEventListener('blur', hideDropdown);

                    globalSearchDropdown.addEventListener('mousedown', (event) => {
                        event.preventDefault();
                    });
                }

                document.body.addEventListener('click', function(event) {
                    if (event.target.closest('#clearSearchIcon')) {
                        handleClearGlobalSearch();
                    }
                });

                function handleClearGlobalSearch() {
                    const globalSearchInput = document.querySelector('input[name="search"]');
                    const globalSearchDropdown = document.getElementById('globalSearchDropdown');

                    if (globalSearchInput) {
                        globalSearchInput.value = '';
                        if (globalSearchDropdown) {
                            globalSearchDropdown.style.display = 'none';
                        }
                    }
                }

                document.body.addEventListener('htmx:afterSwap', function (event) {
                    if (event.detail.target.closest('#globalSearchDropdown .dropdown-content')) {
                        showDropdown();
                    }
                });

                // Handle incoming search query from other pages (if any)
                const urlParams = new URLSearchParams(window.location.search);
                const searchQuery = urlParams.get('q');
                if (searchQuery && globalSearchInput) {
                    globalSearchInput.value = decodeURIComponent(searchQuery);
                    htmx.trigger(globalSearchInput, 'search');
                    history.replaceState(null, '', window.location.pathname);
                }
                // --- End of copied global search logic ---
            });
        </script>

        <!-- Run as Service Info Modal -->
        <div id="runAsServiceModal" class="modal">
            <div class="modal-background"></div>
            <div class="modal-card">
                <header class="modal-card-head">
                    <p class="modal-card-title">Run as Service Information</p>
                    <button class="delete" aria-label="close"></button>
                </header>
                <section class="modal-card-body">
                    <p>Enabling "Run as Service" allows this application to act as a music server, enabling other devices on the network (or with a connection to this device) to stream music from it. When "Run as Service" is enabled, the application will not automatically shut down when all connections close (i.e., no sessions left, either desktop or mobile) but rather will just exist in the background with the tray icon allowing you to close the app manually when desired. Please note that enabling this option does NOT make the application start automatically on system startup; you will still need to launch it manually.</p>
                </section>
                <footer class="modal-card-foot is-flex is-justify-content-center">
                    <button class="button is-success">Got it!</button>
                </footer>
            </div>
        </div>

    <!-- Profile Management Modal -->
    <div id="profileModal" class="modal">
      <div class="modal-background" onclick="document.getElementById('profileModal').classList.remove('is-active');"></div>
      <div class="modal-card">
        <header class="modal-card-head">
          <p class="modal-card-title">Manage Profiles</p>
          <button class="delete" aria-label="close" onclick="document.getElementById('profileModal').classList.remove('is-active');"></button>
        </header>
        <section class="modal-card-body">
          <h5 class="title is-5">Current Profile: <span id="modalCurrentProfileName">Loading...</span></h5>
          <h6 class="title is-6 mt-4">All Profiles:</h6>
          <div class="field is-grouped is-grouped-multiline is-justify-content-center" id="profileList">
            <!-- Profiles will be dynamically loaded here as circular buttons -->
          </div>
          <hr>
          <div class="field has-addons">
              <div class="control is-expanded">
                  <input class="input" type="text" id="newProfileNameInput" placeholder="New Profile Name">
              </div>
              <div class="control">
                  <button class="button is-info" id="createProfileBtn">Create</button>
              </div>
          </div>
          <button class="button is-danger is-fullwidth mt-4" id="deleteCurrentProfileBtn">Delete Current Profile</button>
        </section>
        <footer class="modal-card-foot">
          <button class="button" onclick="document.getElementById('profileModal').classList.remove('is-active');">Close</button>
        </footer>
      </div>
    </div>

    </body>
</html>