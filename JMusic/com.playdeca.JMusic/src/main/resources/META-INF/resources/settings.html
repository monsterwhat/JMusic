<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title id="pageTitle">JMedia Settings</title>

        <script src="/js/theme-initializer.js"></script>

        <!-- Bulma CSS -->
        <link rel="stylesheet" href="/css/bulma.min.css"/>
        <link rel="stylesheet" href="https://unpkg.com/primeicons@7.0.0/primeicons.css">
        <link rel="stylesheet" href="/css/custom.css"/>
        <link rel="stylesheet" href="/css/playback-bar.css"/>

        <!-- HTMX -->
        <script src="/js/htmx.min.js"></script>
        
        <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
        <script>
            document.addEventListener('alpine:init', () => {
                Alpine.store('profile', {
                    currentProfile: null,
                });
            });
        </script>

        <link id="favicon" rel="icon" type="image/x-icon" href="logo.png">

        <style>
            html, body {
                height: 100%;
                background-color: #222;
            }

            body {
                display: flex;
                flex-direction: column;
            }

            .content-wrapper {
                flex-grow: 1;
                overflow: auto;
            }

            #logsPanel::-webkit-scrollbar {
                width: 6px;
            }
            #logsPanel::-webkit-scrollbar-thumb {
                background: #888;
                border-radius: 3px;
            }
            #logsPanel::-webkit-scrollbar-thumb:hover {
                background: #aaa;
            }
        </style>
    </head>
    <body>

        <audio id="audioPlayer" preload="metadata"></audio> 

        <section class="hero is-fullheight">

            <!-- Hero Head (Navbar) -->
            <div class="hero-head">
                <nav class="navbar" role="navigation">
                    <div class="navbar-brand">
                        <a class="navbar-item" href="/index.html"><span class="icon"><i class="pi pi-home"></i></span><strong>JMedia</strong></a>
                        <a role="button" class="navbar-item" id="themeToggle">
                            <i class="pi pi-sun" id="themeIcon"></i>
                        </a>
                        <a role="button" class="navbar-item" id="playerToggle">
                            <i class="pi pi-expand" id="playerIcon"></i>
                        </a>
                        <a role="button" class="navbar-burger" aria-label="menu" aria-expanded="false" data-target="navMenu">
                            <span aria-hidden="true"></span>
                            <span aria-hidden="true"></span>
                            <span aria-hidden="true"></span>
                        </a>
                        <a role="button" class="navbar-item is-hidden-desktop is-hidden-mobile" id="sidebarToggle">
                            <i class="pi pi-bars"></i>
                        </a>
                    </div>
                    <div id="navMenu" class="navbar-menu">
                        <div class="navbar-start">
                        </div>
                        <div class="navbar-item is-expanded" style="justify-content: center;">
                            <div class="navbar-search-container">
                                <div class="control has-icons-right" style="flex-grow: 1;">
                                    <input class="input is-rounded" type="text" placeholder="Search all songs..." name="search" id="globalSearchInput"
                                           hx-get="/api/music/ui/search-results"
                                           hx-trigger="keyup changed delay:500ms, search"
                                           hx-target="#searchResultsContainer"
                                           hx-swap="innerHTML"
                                           hx-include="[name='search']"
                                           hx-indicator="#loadingRow">
                                    <span class="icon is-small is-right is-clickable" id="clearSearchIcon" style="pointer-events: auto;">
                                        <i class="pi pi-times"></i>
                                    </span>
                                </div>
                                <div id="globalSearchDropdown" class="dropdown-menu" role="menu" style="display: none;">
                                    <div id="globalSearchDropdownLoadingIndicator" class="htmx-indicator has-text-centered py-2">
                                        <i class="pi pi-spin pi-spinner" style="font-size: 1.5rem;"></i>
                                    </div>
<div class="dropdown-content"
                                         id="searchSuggestionsDropdown"
                                         hx-trigger="keyup changed delay:300ms from:#globalSearchInput"
                                         hx-vals="js:{searchQuery: document.getElementById('globalSearchInput').value}"
                                         hx-target="this"
                                         hx-swap="innerHTML"
                                         hx-indicator="#globalSearchDropdownLoadingIndicator">
                                        <!-- Suggestions will be loaded here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="navbar-end">
                            <a class="navbar-item" id="openProfileModalBtn">
                                <span class="icon"><i class="pi pi-user"></i></span>
                                <span id="currentProfileName">Loading...</span>
                            </a>
 
                            <a class="navbar-item" href="/settings.html">
                                <span class="icon"><i class="pi pi-cog"></i></span>
                                <span>Settings</span>
                            </a>
                            <a class="navbar-item" href="/import.html">
                                <span class="icon"><i class="pi pi-download"></i></span>
                                <span>Import</span>
                            </a>
                        </div>
                    </div>
                </nav>
            </div>

            <!-- Hero Body (Main content area) -->
            <div class="hero-body m-0 p-0" style="display: block;">
                <div id="mainContent" class="columns p-0 m-0" style="width:100%;">
                    <!-- Settings Content -->
                    <div class="content-wrapper" style="height: calc(100vh - 200px);">
                        <section class="section">
                            <div class="container">
                                <h1 class="title has-text-white">Settings</h1>
                                <div class="columns is-multiline">

                                    <!-- Library Management Card -->
                                    <div class="column is-one-third">
                                        <div class="card has-background-grey-darker has-text-white">
                                            <header class="card-header">
                                                <p class="card-header-title has-text-white">
                                                    Library Management
                                                </p>
                                                <button class="card-header-icon" aria-label="more options" id="toggleLibraryManagementBtn">
                                                    <span class="icon">
                                                        <i class="pi pi-angle-down" aria-hidden="true"></i>
                                                    </span>
                                                </button>
                                            </header>
                                            <div class="card-content" id="libraryManagementContent">
                                                
                                                <!-- Run as Service -->
                                                <div class="field mb-4">
                                                    <label class="switch is-info">
                                                        <input id="runAsServiceToggle" type="checkbox" name="runAsServiceToggle">
                                                        <span class="check"></span>
                                                        <span class="control-label has-text-white">Run as Service</span>
                                                    </label>
                                                </div>

                                                <!-- Music Library Section -->
                                                <div class="mb-5">
                                                    <h6 class="title is-6 has-text-white mb-3">Music Library</h6>
                                                    <div class="field">
                                                        <label class="label has-text-white">Music Library Folder</label>
                                                        <div class="field has-addons">
                                                            <div class="control">
                                                                <button id="browseMusicFolderBtn" class="button is-warning">Browse</button>
                                                            </div>
                                                            <div class="control is-expanded">
                                                                <input id="musicLibraryPathInput" name="musicLibraryPathInput" class="input has-background-grey-darker has-text-white" type="text" placeholder="Select music library folder" value="(not set)">
                                                            </div>
                                                            <div class="control">
                                                                <button id="saveMusicLibraryPathBtn" class="button is-success"
                                                                        hx-post="/api/settings/music-library-path"
                                                                        hx-include="#musicLibraryPathInput"
                                                                        hx-swap="none">Save Path</button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="buttons">
                                                        <button id="scanLibrary" class="button is-primary is-small">Scan Library</button>
                                                        <button id="reloadMetadata" class="button is-info is-small">Reload Metadata</button>
                                                    </div>
                                                </div>

                                                <!-- Video Library Section -->
                                                <div class="mb-5">
                                                    <div class="field">
                                                        <label class="switch is-info">
                                                            <input id="enableVideoLibraryToggle" type="checkbox" name="enableVideoLibraryToggle">
                                                            <span class="check"></span>
                                                            <span class="control-label has-text-white">Enable Video Library (BETA)</span>
                                                        </label>
                                                    </div>
                                                    
                                                    <div id="videoLibraryOptions" class="is-hidden">
                                                        <h6 class="title is-6 has-text-white mb-3">Video Library</h6>
                                                        <div class="field">
                                                            <label class="label has-text-white">Video Library Folder</label>
                                                            <div class="field has-addons">
                                                                <div class="control">
                                                                    <button id="browseVideoFolderBtn" class="button is-warning">Browse</button>
                                                                </div>
                                                                <div class="control is-expanded">
                                                                    <input id="videoLibraryPathInput" name="videoLibraryPathInput" class="input has-background-grey-darker has-text-white" type="text" placeholder="Select video library folder" value="(not set)">
                                                                </div>
                                                                <div class="control">
                                                                    <button id="saveVideoLibraryPathBtn" class="button is-success"
                                                                            hx-post="/api/settings/video-library-path"
                                                                            hx-include="#videoLibraryPathInput"
                                                                            hx-swap="none">Save Path</button>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="buttons">
                                                            <button id="scanVideoLibrary" class="button is-primary is-small"
                                                                    hx-post="/api/video/scan"
                                                                    hx-trigger="click"
                                                                    hx-swap="none">Scan Video Library</button>
                                                            <button id="reloadVideoMetadata" class="button is-info is-small"
                                                                    hx-post="/api/video/reload-metadata"
                                                                    hx-trigger="click"
                                                                    hx-swap="none">Reload Metadata</button>
                                                        </div>
                                                    </div>
                                                </div>

                                                <!-- Data Management Section -->
                                                <div class="mb-3">
                                                    <hr class="has-background-grey-light" style="height: 1px;">
                                                    <h6 class="title is-6 has-text-white mb-3">Data Management</h6>
                                                    <div class="buttons">
                                                        <button id="resetLibrary" class="button is-danger is-small">Reset Music to Default</button>
                                                        <button id="deleteDuplicates" class="button is-danger is-small">Delete Music Duplicates</button>
                                                        <button id="clearSongs" class="button is-danger is-small">Clear Songs DB</button>
                                                        <button id="clearPlaybackHistory" hx-post="/api/settings/clearPlaybackHistory" class="button is-danger is-small">Clear Playback History</button>
                                                        <button id="resetVideoDb" class="button is-danger is-small">Reset Video Database</button>
                                                    </div>
                                                </div>


                                            </div>
                                        </div>
                                    </div>

                                    <!-- Import Installation Card -->
                                    <div class="column is-one-third" id="importInstallationCardColumn">
                                        <div class="card has-background-grey-darker has-text-white" id="importInstallationCard">
                                            <header class="card-header">
                                                <p class="card-header-title has-text-white">
                                                    Import Installation
                                                </p>
                                                <button class="card-header-icon" aria-label="more options" id="toggleImportInstallationBtn">
                                                    <span class="icon">
                                                        <i class="pi pi-angle-down" aria-hidden="true"></i>
                                                    </span>
                                                </button>
                                            </header>
                                            <div class="card-content" id="importInstallationContent">
                                                <div class="notification is-warning is-light" id="installationRequiredDialog">
                                                    <strong>Import features require additional installations.</strong>
                                                    <p class="mb-3">The following components need to be installed to enable music import functionality:</p>
                                                    <ul class="mb-4" id="missingComponentsList">
                                                        <!-- Components will be dynamically added here -->
                                                    </ul>
                                                    <p class="is-size-7">Note: On Windows, Python and FFmpeg are installed via Chocolatey, then SpotDL and Whisper via pip (Python).</p>
                                                </div>
                                                
                                                <!-- Python Installation -->
                                                <div class="field mb-3">
                                                    <div class="level is-mobile">
                                                        <div class="level-left">
                                                            <label class="label has-text-white mb-0">Python</label>
                                                        </div>
                                                        <div class="level-right">
                                                            <button id="installPythonBtn" class="button is-success is-rounded is-small">
                                                                <i class="pi pi-download mr-1"></i>
                                                                Install Python
                                                            </button>
                                                        </div>
                                                    </div>
                                                    <div class="mt-2" id="pythonProgressContainer" style="display: none;">
                                                        <progress id="pythonInstallProgress" class="progress is-small is-info" value="0" max="100">0%</progress>
                                                    </div>
                                                    <p id="pythonStatus" class="help is-size-7 mt-2">Not installed</p>
                                                </div>
                                                
                                                <!-- FFmpeg Installation -->
                                                <div class="field mb-3">
                                                    <div class="level is-mobile">
                                                        <div class="level-left">
                                                            <label class="label has-text-white mb-0">FFmpeg</label>
                                                        </div>
                                                        <div class="level-right">
                                                            <button id="installFfmpegBtn" class="button is-success is-rounded is-small">
                                                                <i class="pi pi-download mr-1"></i>
                                                                Install FFmpeg
                                                            </button>
                                                        </div>
                                                    </div>
                                                    <div class="mt-2" id="ffmpegProgressContainer" style="display: none;">
                                                        <progress id="ffmpegInstallProgress" class="progress is-small is-info" value="0" max="100">0%</progress>
                                                    </div>
                                                    <p id="ffmpegStatus" class="help is-size-7 mt-2">Not installed</p>
                                                </div>
                                                
                                                <!-- SpotDL Installation -->
                                                <div class="field mb-3">
                                                    <div class="level is-mobile">
                                                        <div class="level-left">
                                                            <label class="label has-text-white mb-0">SpotDL</label>
                                                        </div>
                                                        <div class="level-right">
                                                            <button id="installSpotdlBtn" class="button is-success is-rounded is-small">
                                                                <i class="pi pi-download mr-1"></i>
                                                                Install SpotDL
                                                            </button>
                                                        </div>
                                                    </div>
                                                    <div class="mt-2" id="spotdlProgressContainer" style="display: none;">
                                                        <progress id="spotdlInstallProgress" class="progress is-small is-info" value="0" max="100">0%</progress>
                                                    </div>
                                                    <p id="spotdlStatus" class="help is-size-7 mt-2">Not installed</p>
                                                </div>
                                                
                                                <!-- Whisper Installation -->
                                                <div class="field mb-3">
                                                    <div class="level is-mobile">
                                                        <div class="level-left">
                                                            <label class="label has-text-white mb-0">Whisper</label>
                                                        </div>
                                                        <div class="level-right">
                                                            <button id="installWhisperBtn" class="button is-success is-rounded is-small">
                                                                <i class="pi pi-download mr-1"></i>
                                                                Install Whisper
                                                            </button>
                                                        </div>
                                                    </div>
                                                    <div class="mt-2" id="whisperProgressContainer" style="display: none;">
                                                        <progress id="whisperInstallProgress" class="progress is-small is-info" value="0" max="100">0%</progress>
                                                    </div>
                                                    <p id="whisperStatus" class="help is-size-7 mt-2">Not installed</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>



                                    <!-- Import Settings Card -->
                                    <div class="column is-one-third is-hidden" id="importSettingsCardColumn">
                                        <div class="card has-background-grey-darker has-text-white" id="importSettingsCard">
                                            <header class="card-header">
                                                <p class="card-header-title has-text-white">
                                                    Import Settings
                                                </p>
                                                <button class="card-header-icon" aria-label="more options" id="toggleImportSettingsBtn">
                                                    <span class="icon">
                                                        <i class="pi pi-angle-down" aria-hidden="true"></i>
                                                    </span>
                                                </button>
                                            </header>
                                            <div class="card-content" id="importSettingsContent">
                                                <div class="field">
                                                    <label class="label has-text-white" for="outputFormat">Output Format</label>
                                                    <div class="control">
                                                        <div class="select is-fullwidth">
                                                            <select id="outputFormat">
                                                                <option value="mp3">MP3</option>
                                                                <option value="flac">FLAC</option>
                                                                <option value="ogg">OGG</option>
                                                                <option value="opus">OPUS</option>
                                                                <option value="m4a">M4A</option>
                                                                <option value="wav">WAV</option>
                                                            </select>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="columns">
                                                    <div class="column">
                                                        <div class="field">
                                                            <label class="label has-text-white" for="downloadThreads">Download Threads</label>
                                                            <div class="control">
                                                                <input class="input" type="number" id="downloadThreads" value="4" min="1">
                                                            </div>
                                                        </div> 
                                                    </div>
                                                    <div class="column">
                                                        <div class="field">
                                                            <label class="label has-text-white" for="searchThreads">Search Threads</label>
                                                            <div class="control">
                                                                <input class="input" type="number" id="searchThreads" value="4" min="1">
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="buttons mt-3">
                                                    <button id="saveImportSettingsBtn" class="button is-success is-fullwidth">Save</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Logs Card -->
                                    <div class="column is-one-third">
                                        <div class="card has-background-grey-darker has-text-white">
                                            <header class="card-header">
                                                <p class="card-header-title has-text-white">
                                                    Logs
                                                </p>
                                                <button class="card-header-icon" aria-label="more options" id="toggleLogsBtn">
                                                    <span class="icon">
                                                        <i class="pi pi-angle-down" aria-hidden="true"></i>
                                                    </span>
                                                </button>
                                            </header>
                                            <div class="card-content" id="logsCardContent">
                                                <div style="max-height: 200px; overflow-y: auto;" id="logsPanel">
                                                    <!-- JS will populate logs here -->
                                                </div>
                                                <div class="buttons mt-3">
                                                    <button id="clearLogs" class="button is-danger is-small">Clear Logs</button>
                                                </div>

                                            </div>
                                        </div>
                                    </div> 




                                </div>
                            </div>
                        </section>
                    </div> 
                </div>
            </div>

            <!-- Hero Foot (Music Bar) -->
            <div class="hero-foot card has-background-grey-darker has-text-white m-3 p-3">
                <nav class="level is-mobile">

                    <!-- LEFT: Song Info -->
                    <div class="level-left is-hidden-mobile">
                        <div class="level-item">
                            <div class="image-container mr-3">
                                <figure class="image is-96x96">
                                    <img id="songCoverImage" src="/logo.png" alt="Song Cover">
                                </figure>
                                <button id="expandImageBtn">
                                    <span class="icon is-small"><i class="pi pi-expand"></i></span>
                                </button>
                            </div>
                            <div>
                                <p id="songTitle" class="has-text-white has-text-weight-semibold is-size-6">Loading...</p>
                                <p id="songArtist" class="has-text-success is-size-7">Unknown Artist</p>
                            </div>
                        </div>
                    </div>

                    <!-- CENTER: Controls + Progress -->
                    <div class="level-item has-text-centered is-flex is-flex-direction-column is-align-items-center" style="width: 100%; flex-grow: 1; flex-shrink: 1;">
                        <!-- Playback buttons -->
                        <div class="buttons are-small mb-2">
                            <button id="shuffleBtn" title="Shuffle"><i id="shuffleIcon" class="pi pi-sort-alt"></i></button>
                            <button id="prevBtn"  title="Previous"><i class="pi pi-step-backward"></i></button>
                            <button id="playPauseBtn"  title="Play/Pause"><i id="playPauseIcon" class="pi pi-play"></i></button>
                            <button id="nextBtn"   title="Next"><i id="nextIcon" class="pi pi-step-forward"></i></button>
                            <button id="repeatBtn"   title="Repeat"><i id="repeatIcon" class="pi pi-refresh"></i></button>
                        </div>

                        <!-- Progress bar -->
                        <div class="is-flex is-align-items-center is-justify-content-center" style="width: 100%;">
                            <span id="currentTime" class="has-text-success has-text-weight-semibold is-size-6 mr-2">0:00</span>
                            <input type="range" min="0" max="100" value="0"
                                   style="width:100%"
                                   name="seconds" id="playbackProgressBar"/>
                            <span id="totalTime" class="has-text-success has-text-weight-semibold is-size-6 ml-2">0:00</span>
                        </div>

                        <!-- Song Info for mobile -->
                        <div class="is-hidden-desktop mt-2" style="width: 100%;">
                            <div style="overflow: hidden;">
                                <p id="songTitleMobile" class="has-text-white has-text-weight-semibold is-size-6 marquee">Loading...</p>
                            </div>
                            <div style="overflow: hidden;">
                                <p id="songArtistMobile" class="has-text-success is-size-7 marquee">Unknown Artist</p>
                            </div>
                        </div>
                    </div>

                    <!-- RIGHT: Volume -->
                    <div class="level-right is-hidden-mobile">
                        <div class="level-item">
                            <div class="is-flex is-align-items-center">
                                <i class="pi pi-volume-up has-text-white mr-2"></i>
                                <input type="range" min="0" max="100" value="80" name="level" id="volumeProgressBar"/>
                            </div>
                        </div>
                    </div> 
                </nav>
            </div>

        </section>

        <!-- Toast Container -->
        <div id="toast-container" style="position: fixed; top: 20px; right: 20px; z-index: 10000;"></div>

        <script src="/js/musicBar.js"></script>
        <script src="/js/mediaSession.js"></script>
        <script src="/js/settings.js"></script>
        <script src="/js/video-settings.js"></script>
        <script src="/js/navbar.js"></script>
        <script src="/js/profileManager.js"></script>

        <script>
        // Toast Notification System
        function showToast(message, type = 'info', duration = 3000) {
            const toastContainer = document.getElementById('toast-container');
            if (!toastContainer) return;
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            // Add icon based on type
            let icon = '';
            switch(type) {
                case 'success':
                    icon = '<i class="pi pi-check toast-icon"></i>';
                    break;
                case 'error':
                    icon = '<i class="pi pi-times toast-icon"></i>';
                    break;
                case 'info':
                default:
                    icon = '<i class="pi pi-info toast-icon"></i>';
                    break;
            }
            
            toast.innerHTML = `
                ${icon}
                <span class="toast-message">${message}</span>
            `;
            
            toastContainer.appendChild(toast);
            
            // Trigger animation
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);
            
            // Remove toast after duration
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, duration);
        }
        </script>

        <script>
            window.globalActiveProfileId = localStorage.getItem('activeProfileId') || '1'; // Default to '1' (Main profile) if not set

            // Listen for profile switches from profileManager.js
            document.body.addEventListener('profileSwitched', (event) => {
                window.globalActiveProfileId = localStorage.getItem('activeProfileId');
                console.log('Profile switched event received. New globalActiveProfileId:', globalActiveProfileId);
                // Trigger a full page reload or update all relevant HTMX components
                // For simplicity and full refresh of profile-specific data, a reload is best here.
                location.reload();
            });

            // Set dynamic URLs for HTMX elements that need profileId
            function updateHmxUrls() {
                const searchSuggestionsDropdown = document.getElementById('searchSuggestionsDropdown');
                if (searchSuggestionsDropdown) {
                    searchSuggestionsDropdown.setAttribute('hx-post', `/api/music/ui/search-suggestions/${globalActiveProfileId}`);
                }
            }

            // Update URLs initially and when profile switches
            updateHmxUrls();
            document.body.addEventListener('profileSwitched', updateHmxUrls);

            // HTMX request interception to inject profileId into URLs
            document.body.addEventListener('htmx:beforeRequest', function (event) {
                let targetUrl = event.detail.path;

                // ADD THIS CHECK: Ensure targetUrl is a string before proceeding
                if (typeof targetUrl !== 'string' || !targetUrl) {
                    return; // Exit the function if targetUrl is invalid
                }

                let newUrl = targetUrl; // Initialize newUrl with targetUrl
                const currentProfileId = globalActiveProfileId; // Get the currently active profile ID

                // Skip profile-related API calls that handle profile creation/deletion/switching directly
                // These already include the necessary profile IDs or operate globally.
                if (targetUrl.startsWith('/api/profiles')) {
                    // For example, /api/profiles (GET all), /api/profiles/{id} (DELETE), /api/profiles (POST create)
                    // /api/profiles/current, /api/profiles/switch/{id} are handled by profileManager.js or don't need globalActiveProfileId injected here.
                    return;
                }

                // All other API calls related to music or settings that need profileId
                if (targetUrl.startsWith('/api/music/') || targetUrl.startsWith('/api/settings/')) {
                    const parts = targetUrl.split('/');
                    const module = parts[2]; // 'music' or 'settings'

                    if (module === 'music') {
                        const subModule = parts[3]; // e.g., 'ui', 'playback', 'queue', 'playlists'

                        if (subModule === 'ui') {
                            // Pattern: /api/music/ui/{profileId}/...
                            // Examples: /api/music/ui/playlists-fragment, /api/music/ui/tbody/{profileId}/0, /api/music/ui/search-suggestions/{profileId}
                            // Special case for search-suggestions: /api/music/ui/search-suggestions -> /api/music/ui/search-suggestions/{profileId}
                            if (parts[4] === 'search-suggestions') {
                                newUrl = `/api/music/ui/search-suggestions/${currentProfileId}`;
                            } else if (parts[4] === 'tbody' && parts[5] === '{playlistId}') {
                                // Special case for tbody: /api/music/ui/tbody/{playlistId} -> /api/music/ui/tbody/{currentProfileId}
                                newUrl = `/api/music/ui/tbody/${currentProfileId}`;
                            } else if (parts[4] === 'playlists-fragment' && parts[5] === '{profileId}') {
                                // Special case for playlists-fragment: /api/music/ui/playlists-fragment/{profileId} -> /api/music/ui/playlists-fragment/{currentProfileId}
                                newUrl = `/api/music/ui/playlists-fragment/${currentProfileId}`;
                            } else if (parts[4] === 'playlist-view' && parts[5] === '{profileId}') {
                                // Special case for playlist-view: /api/music/ui/playlist-view/{profileId} -> /api/music/ui/playlist-view/{currentProfileId}
                                newUrl = `/api/music/ui/playlist-view/${currentProfileId}`;
                            } else if (parts[4] === 'queue-fragment' && parts[5] === '{profileId}') {
                                // Special case for queue-fragment: /api/music/ui/queue-fragment/{profileId} -> /api/music/ui/queue-fragment/{currentProfileId}
                                newUrl = `/api/music/ui/queue-fragment/${currentProfileId}`;
                            } else if (parts[4] === 'add-to-playlist-dialog' && parts[5] === '{profileId}') {
                                // Special case for add-to-playlist-dialog: /api/music/ui/add-to-playlist-dialog/{profileId} -> /api/music/ui/add-to-playlist-dialog/${currentProfileId}
                                newUrl = `/api/music/ui/add-to-playlist-dialog/${currentProfileId}`;
                            } else if (parts[4] !== currentProfileId) { // Check if profileId is NOT already correctly placed
                                newUrl = `/api/music/ui/${currentProfileId}` + targetUrl.substring('/api/music/ui'.length);
                            }
                        } else if (subModule === 'playback') {
                            // Pattern: /api/music/playback/{action}/{profileId}/{id?}
                            // Examples: /api/music/playback/queue-all/0, /api/music/playback/select/123, /api/music/playback/toggle
                            const action = parts[4];
                            if (action === 'queue-all' || action === 'select') {
                                // For /api/music/playback/queue-all/{playlistId}, /api/music/playback/select/{songId}
                                // Needs to become /api/music/playback/{action}/{profileId}/{id}
                                newUrl = `/api/music/playback/${action}/${currentProfileId}/${parts[5]}`;
                            } else if (action === 'volume' || action === 'position') {
                                // For /api/music/playback/volume/{level}, /api/music/playback/position/{seconds}
                                // Needs to become /api/music/playback/{action}/{profileId}/{value}
                                newUrl = `/api/music/playback/${action}/${currentProfileId}/${parts[5]}`;
                            } else {
                                // For actions like /api/music/playback/toggle, /api/music/playback/play, /api/music/playback/next, etc.
                                // Needs to become /api/music/playback/{action}/{profileId}
                                if (parts.length < 5 || parts[5] !== currentProfileId) { // If profileId is not appended
                                    newUrl = `${targetUrl}/${currentProfileId}`;
                                }
                            }
                        } else if (subModule === 'queue') {
                            // Pattern: /api/music/queue/{profileId}/{action}/{id?}
                            // Examples: /api/music/queue/add/{songId}, /api/music/queue/skip-to/{index}, /api/music/queue/clear
                            const action = parts[4];
                            if (action === 'add' || action === 'skip-to' || action === 'remove') {
                                // /api/music/queue/{action}/{songId/index} -> /api/music/queue/{action}/{profileId}/{songId/index}
                                newUrl = `/api/music/queue/${action}/${currentProfileId}/${parts[5]}`;
                            } else if (action === 'clear') {
                                // /api/music/queue/clear -> /api/music/queue/clear/{profileId}
                                newUrl = `/api/music/queue/clear/${currentProfileId}`;
                            } else if (parts.length === 4) { // This is likely /api/music/queue (GET current queue for profile)
                                newUrl = `/api/music/queue/${currentProfileId}`;
                            }
                        } else if (subModule === 'playlists') {
                            // Pattern: /api/music/playlists/{playlistId}/songs/{songId}/toggle/{profileId}
                            // Only handles the specific toggle case where profileId is at the end.
                            // Other playlist APIs (create, delete, get playlists themselves) might be global or handled differently.
                            if (parts.length >= 7 && parts[6] === 'toggle') { // Check if it's the toggle action
                                if (parts.length < 8 || parts[7] !== currentProfileId) { // Check if profileId is not appended
                                    newUrl = `${targetUrl}/${currentProfileId}`;
                                }
                            }
                        }
                    } else if (module === 'settings') {
                        // Handle various settings endpoints that need profileId
                        const settingPath = parts[3];
                        if (settingPath === 'clearPlaybackHistory') {
                            // Pattern: /api/settings/clearPlaybackHistory/{profileId}
                            if (parts.length < 5 || parts[4] !== currentProfileId) { // If profileId is not appended
                                newUrl = `${targetUrl}/${currentProfileId}`;
                            }
                        } else if (settingPath === 'music-library-path' || settingPath === 'video-library-path') {
                            // Pattern: /api/settings/music-library-path or /api/settings/video-library-path
                            // These need to become /api/settings/{settingPath}/{profileId}
                            if (parts.length < 5 || parts[4] !== currentProfileId) { // If profileId is not appended
                                newUrl = `${targetUrl}/${currentProfileId}`;
                            }
                        }
                    }
                }

                if (newUrl !== targetUrl) {
                    event.detail.path = newUrl;
                    console.log('HTMX Request URL modified to:', event.detail.path);
                }
            });
 
            document.addEventListener('DOMContentLoaded', async () => {
                const importSettingsCardColumn = document.getElementById('importSettingsCardColumn');
                const importInstallationCardColumn = document.getElementById('importInstallationCardColumn');
                
                if (importSettingsCardColumn && importInstallationCardColumn) {
                    try {
                        const response = await fetch(`/api/settings/${globalActiveProfileId}/import-capability`);
                        const data = await response.json();
                        if (response.ok) {
                            if (data.data === true) {
                                // Show settings card, hide installation card
                                importSettingsCardColumn.classList.remove('is-hidden');
                                importInstallationCardColumn.classList.add('is-hidden');
                            } else {
                                // Show installation card, hide settings card
                                importInstallationCardColumn.classList.remove('is-hidden');
                                importSettingsCardColumn.classList.add('is-hidden');
                        }
                        }
                    } catch (error) {
                        console.error('Failed to fetch import capability status:', error);
                        // Show installation card by default on error
                        importInstallationCardColumn.classList.remove('is-hidden');
                        importSettingsCardColumn.classList.add('is-hidden');
                    }
                }



                // --- Start of copied global search logic ---
                const globalSearchInput = document.querySelector('input[name="search"]');
                const globalSearchDropdown = document.getElementById('globalSearchDropdown');

                function showDropdown() {
                    if (globalSearchInput.value.trim() !== '' && globalSearchDropdown.querySelector('.dropdown-item, .htmx-indicator')) {
                        globalSearchDropdown.style.display = 'block';
                    } else {
                        globalSearchDropdown.style.display = 'none';
                    }
                }

                function hideDropdown() {
                    setTimeout(() => {
                        if (!globalSearchInput.matches(':focus')) {
                            globalSearchDropdown.style.display = 'none';
                        }
                    }, 100);
                }

                if (globalSearchInput && globalSearchDropdown) {
                    globalSearchInput.addEventListener('focus', showDropdown);
                    globalSearchInput.addEventListener('keyup', showDropdown);
                    globalSearchInput.addEventListener('blur', hideDropdown);

                    globalSearchDropdown.addEventListener('mousedown', (event) => {
                        event.preventDefault();
                    });
                }

                document.body.addEventListener('click', function(event) {
                    if (event.target.closest('#clearSearchIcon')) {
                        handleClearGlobalSearch();
                    }
                });

                function handleClearGlobalSearch() {
                    const globalSearchInput = document.querySelector('input[name="search"]');
                    const globalSearchDropdown = document.getElementById('globalSearchDropdown');

                    if (globalSearchInput) {
                        globalSearchInput.value = '';
                        if (globalSearchDropdown) {
                            globalSearchDropdown.style.display = 'none';
                        }
                    }
                }

                document.body.addEventListener('htmx:afterSwap', function (event) {
                    if (event.detail.target.closest('#globalSearchDropdown .dropdown-content')) {
                        showDropdown();
                    }
                });

                // Handle incoming search query from other pages (if any)
                const urlParams = new URLSearchParams(window.location.search);
                const searchQuery = urlParams.get('q');
                if (searchQuery && globalSearchInput) {
                    globalSearchInput.value = decodeURIComponent(searchQuery);
                    htmx.trigger(globalSearchInput, 'search');
                    history.replaceState(null, '', window.location.pathname);
                }
                // --- End of copied global search logic ---
            });
        </script>

        <!-- Run as Service Info Modal -->
        <div id="runAsServiceModal" class="modal">
            <div class="modal-background"></div>
            <div class="modal-card">
                <header class="modal-card-head">
                    <p class="modal-card-title">Run as Service Information</p>
                    <button class="delete" aria-label="close"></button>
                </header>
                <section class="modal-card-body">
                    <p>Enabling "Run as Service" allows this application to act as a music server, enabling other devices on the network (or with a connection to this device) to stream music from it. When "Run as Service" is enabled, the application will not automatically shut down when all connections close (i.e., no sessions left, either desktop or mobile) but rather will just exist in the background with the tray icon allowing you to close the app manually when desired. Please note that enabling this option does NOT make the application start automatically on system startup; you will still need to launch it manually.</p>
                </section>
                <footer class="modal-card-foot is-flex is-justify-content-center">
                    <button class="button is-success">Got it!</button>
                </footer>
            </div>
        </div>

    <!-- Profile Management Modal -->
    <div id="profileModal" class="modal">
      <div class="modal-background" onclick="document.getElementById('profileModal').classList.remove('is-active');"></div>
      <div class="modal-card">
        <header class="modal-card-head">
          <p class="modal-card-title">Manage Profiles</p>
          <button class="delete" aria-label="close" onclick="document.getElementById('profileModal').classList.remove('is-active');"></button>
        </header>
        <section class="modal-card-body">
          <h5 class="title is-5">Current Profile: <span id="modalCurrentProfileName">Loading...</span></h5>
          <h6 class="title is-6 mt-4">All Profiles:</h6>
          <div class="field is-grouped is-grouped-multiline is-justify-content-center" id="profileList">
            <!-- Profiles will be dynamically loaded here as circular buttons -->
          </div>
          <hr>
          <div class="field has-addons">
              <div class="control is-expanded">
                  <input class="input" type="text" id="newProfileNameInput" placeholder="New Profile Name">
              </div>
              <div class="control">
                  <button class="button is-info" id="createProfileBtn">Create</button>
              </div>
          </div>
          <button class="button is-danger is-fullwidth mt-4" id="deleteCurrentProfileBtn">Delete Current Profile</button>
        </section>
        <footer class="modal-card-foot">
          <button class="button" onclick="document.getElementById('profileModal').classList.remove('is-active');">Close</button>
        </footer>
      </div>
    </div>

    </body>
</html>

<!-- Installation Progress Dialog -->
<div id="installDialog" class="modal">
    <div class="modal-background"></div>
    <div class="modal-card">
        <header class="modal-card-head">
            <p class="modal-card-title">Installing Requirements</p>
            <button class="delete" aria-label="close" id="closeInstallDialog"></button>
        </header>
        <section class="modal-card-body">
            <div class="content">
                <p class="mb-3">Installing Python, FFmpeg, and SpotDL...</p>
                
                <div class="field">
                    <label class="label has-text-white">Installation Output</label>
                    <div class="control">
                        <div id="installOutput" class="textarea has-background-black has-text-success" rows="15" readonly>
                            Starting installation...
                        </div>
                    </div>
                </div>
                
                <div class="field">
                    <div class="control">
                        <progress id="installProgress" class="progress is-small is-info" value="0" max="100">0%</progress>
                    </div>
                </div>
            </div>
        </section>
        <footer class="modal-card-foot">
            <button class="button is-danger" id="cancelInstallBtn">Cancel Installation</button>
        </footer>
    </div>
</div>