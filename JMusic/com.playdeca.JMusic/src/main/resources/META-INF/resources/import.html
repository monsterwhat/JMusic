<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title id="pageTitle">Spotdl/Yt-dlp Interface</title>
        <script src="/js/theme-initializer.js"></script>
        <link rel="stylesheet" href="/css/bulma.min.css"/>
        <link rel="stylesheet" href="https://unpkg.com/primeicons@7.0.0/primeicons.css">
        <link rel="stylesheet" href="/css/custom.css"/>
        <link rel="stylesheet" href="/css/playback-bar.css"/>
        <script src="/js/htmx.min.js"></script>
        <!-- Alpine.js -->
        <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
        <link id="favicon" rel="icon" type="image/x-icon" href="logo.png">
    </head>
    <body>
        <script>
            // Define globalActiveProfileId as a property of the window object
            window.globalActiveProfileId = localStorage.getItem('activeProfileId') || '1';
        </script>
        <audio id="audioPlayer" preload="metadata"></audio>

        <section class="hero is-fullheight">
            <div class="hero-head">
                <nav class="navbar" role="navigation">
                    <div class="navbar-brand">
                        <a class="navbar-item" href="/index.html"><span class="icon"><i class="pi pi-home"></i></span><strong>JMusic</strong></a>
                        <a role="button" class="navbar-item" id="themeToggle">
                            <i class="pi pi-sun" id="themeIcon"></i>
                        </a>
                        <a role="button" class="navbar-item" id="playerToggle">
                            <i class="pi pi-expand" id="playerIcon"></i>
                        </a>
                        <a role="button" class="navbar-burger" aria-label="menu" aria-expanded="false" data-target="navMenu">
                            <span aria-hidden="true"></span>
                            <span aria-hidden="true"></span>
                            <span aria-hidden="true"></span>
                        </a>
                        <a role="button" class="navbar-item is-hidden-desktop is-hidden-mobile" id="sidebarToggle">
                            <i class="pi pi-bars"></i>
                        </a>
                    </div>
                    <div id="navMenu" class="navbar-menu">
                        <div class="navbar-start">
                        </div>
                        <div class="navbar-item is-expanded" style="justify-content: center;">
                            <div class="navbar-search-container">
                                <div class="control has-icons-right" style="flex-grow: 1;">
                                    <input class="input is-rounded" type="text" placeholder="Search all songs..." name="search" id="globalSearchInput"
                                           hx-get="/api/music/ui/search-results"
                                           hx-trigger="keyup changed delay:500ms, search"
                                           hx-target="#searchResultsContainer"
                                           hx-swap="innerHTML"
                                           hx-include="[name='search']"
                                           hx-indicator="#loadingRow">
                                    <span class="icon is-small is-right is-clickable" id="clearSearchIcon" style="pointer-events: auto;">
                                        <i class="pi pi-times"></i>
                                    </span>
                                </div>
                                <div id="globalSearchDropdown" class="dropdown-menu" role="menu" style="display: none;">
                                    <div id="globalSearchDropdownLoadingIndicator" class="htmx-indicator has-text-centered py-2">
                                        <i class="pi pi-spin pi-spinner" style="font-size: 1.5rem;"></i>
                                    </div>
                                    <div class="dropdown-content"
                                         hx-post="/api/music/ui/search-suggestions"
                                         hx-trigger="keyup changed delay:300ms from:#globalSearchInput"
                                         hx-vals="js:{searchQuery: document.getElementById('globalSearchInput').value}"
                                         hx-target="this"
                                         hx-swap="innerHTML"
                                         hx-indicator="#globalSearchDropdownLoadingIndicator">
                                        <!-- Suggestions will be loaded here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="navbar-end">
                            <a class="navbar-item" id="openProfileModalBtn">
                                <span class="icon"><i class="pi pi-user"></i></span>
                                <span id="currentProfileName">Loading...</span>
                            </a>

                            <a class="navbar-item" href="/settings.html">
                                <span class="icon"><i class="pi pi-cog"></i></span>
                                <span>Settings</span>
                            </a>
                            <a class="navbar-item" href="/import.html">
                                <span class="icon"><i class="pi pi-download"></i></span>
                                <span>Import</span>
                            </a>
                        </div>
                    </div>
                </nav>
            </div>

            <div id="mainContent" class="hero-body">
                <div class="container">
                    <h1 class="title has-text-white">Import Interface</h1>
                    <div id="externalAppWarning" class="notification is-info">
                        <button class="delete"></button>
                        This page allows you to interface with the external <a href="https://spotdl.rtfd.io/" target="_blank">SpotDL</a> application.
                        Please ensure that Python, SpotDL (installed via pip), and FFmpeg are correctly installed and configured on your system's PATH for this functionality to work.
                        JMusic does not manage these external applications; it only provides a user interface to send commands to them.
                    </div>
                    <div id="spotdlWarningMessage" class="notification is-warning is-hidden">
                        <!-- Warning messages will be displayed here -->
                    </div>
                    <div class="box has-background-grey-darker">                        
                        <div class="columns">
                            <div class="column">
                                <div class="field">
                                    <label class="label has-text-white" for="spotdlUrl">Song:</label>
                                    <div class="control">
                                        <input class="input" type="text" id="spotdlUrl" placeholder="Enter a song name or a Spotify or YouTube URL (playlists work)">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="field">
                            <label class="label has-text-white" for="downloadFolder">Download Folder</label>
                            <div class="control">
                                <input class="input" type="text" id="downloadFolder" placeholder="e.g., C:\Music\SpotDL">
                            </div>
                        </div>

                        <div class="field">
                            <label class="label has-text-white">Playlist Selection (Optional)</label>
                            <div class="columns is-mobile">
                                <div class="column is-half">
                                    <div class="control">
                                        <div class="select is-fullwidth">
                                            <select id="playlistSelect">
                                                <option value="">-- Select existing playlist --</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="column is-half">
                                    <div class="control">
                                        <input class="input" type="text" id="newPlaylistName" placeholder="Or create new playlist">
                                    </div>
                                    </div>
                            </div>
                        </div>

                        <div class="field">
                            <div class="control">
                                <button class="button is-warning is-fullwidth" id="downloadBtn">Find And Download</button>
                            </div>
                        </div>
                        <div class="field mt-4">
                            <label class="label has-text-white">Import Output</label>
                            <div class="control">
                                <textarea class="textarea has-background-black has-text-success" id="spotdlOutput" rows="10" readonly></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="hero-foot card has-background-grey-darker has-text-white m-3 p-3">
                <nav class="level is-mobile">
                    <div class="level-left is-hidden-mobile">
                        <div class="level-item">
                            <div class="image-container mr-3">
                                <figure class="image is-96x96">
                                    <img id="songCoverImage" src="/logo.png" alt="Song Cover">
                                </figure>
                                <button id="expandImageBtn">
                                    <span class="icon is-small"><i class="pi pi-expand"></i></span>
                                </button>
                            </div>
                            <div>
                                <p id="songTitle" class="has-text-white has-text-weight-semibold is-size-6">Loading...</p>
                                <p id="songArtist" class="has-text-success is-size-7">Unknown Artist</p>
                            </div>
                        </div>
                    </div>
                    <div class="level-item has-text-centered is-flex is-flex-direction-column is-align-items-center" style="width: 100%; flex-grow: 1; flex-shrink: 1;">
                        <div class="buttons are-small mb-2">
                            <button id="shuffleBtn" title="Shuffle"><i id="shuffleIcon" class="pi pi-sort-alt"></i></button>
                            <button id="prevBtn"  title="Previous"><i class="pi pi-step-backward"></i></button>
                            <button id="playPauseBtn"  title="Play/Pause"><i id="playPauseIcon" class="pi pi-play"></i></button>
                            <button id="nextBtn"   title="Next"><i id="nextIcon" class="pi pi-step-forward"></i></button>
                            <button id="repeatBtn"   title="Repeat"><i id="repeatIcon" class="pi pi-refresh"></i></button>
                        </div>
                        <div class="is-flex is-align-items-center is-justify-content-center" style="width: 100%;">
                            <span id="currentTime" class="has-text-success has-text-weight-semibold is-size-6 mr-2">0:00</span>
                            <input type="range" min="0" max="100" value="0"
                                   style="width:100%"
                                   name="seconds" id="playbackProgressBar"/>
                            <span id="totalTime" class="has-text-success has-text-weight-semibold is-size-6 ml-2">0:00</span>
                        </div>
                        <div class="is-hidden-desktop mt-2" style="width: 100%;">
                            <div style="overflow: hidden;">
                                <p id="songTitleMobile" class="has-text-white has-text-weight-semibold is-size-6 marquee">Loading...</p>
                            </div>
                            <div style="overflow: hidden;">
                                <p id="songArtistMobile" class="has-text-success is-size-7 marquee">Unknown Artist</p>
                            </div>
                        </div>
                    </div>
                    <div class="level-right is-hidden-mobile">
                        <div class="level-item">
                            <div class="is-flex is-align-items-center">
                                <i class="pi pi-volume-up has-text-white mr-2"></i>
                                <input type="range" min="0" max="100" value="80" name="level" id="volumeProgressBar"/>
                            </div>
                        </div>
                    </div> 
                </nav>
            </div>
        </section>
        <script src="/js/musicBar.js"></script>
        <script src="/js/mediaSession.js"></script>
        <script src="/js/playlistBar.js"></script>
        <script src="/js/navbar.js"></script>
        <script src="/js/profileManager.js"></script>
        <script src="/js/songQueue.js"></script>
        <script src="/js/import.js"></script>
        <!-- Profile Management Modal -->
        <div id="profileModal" class="modal">
            <div class="modal-background" onclick="document.getElementById('profileModal').classList.remove('is-active');"></div>
            <div class="modal-card">
                <header class="modal-card-head">
                    <p class="modal-card-title">Manage Profiles</p>
                    <button class="delete" aria-label="close" onclick="document.getElementById('profileModal').classList.remove('is-active');"></button>
                </header>
                <section class="modal-card-body">
                    <h5 class="title is-5">Current Profile: <span id="modalCurrentProfileName">Loading...</span></h5>
                    <h6 class="title is-6 mt-4">All Profiles:</h6>
                    <div class="field is-grouped is-grouped-multiline is-justify-content-center" id="profileList">
                        <!-- Profiles will be dynamically loaded here as circular buttons -->
                    </div>
                    <hr>
                    <div class="field has-addons">
                        <div class="control is-expanded">
                            <input class="input" type="text" id="newProfileNameInput" placeholder="New Profile Name">
                        </div>
                        <div class="control">
                            <button class="button is-info" id="createProfileBtn">Create</button>
                        </div>
                    </div>
                    <button class="button is-danger is-fullwidth mt-4" id="deleteCurrentProfileBtn">Delete Current Profile</button>
                </section>
                <footer class="modal-card-foot">
                    <button class="button" onclick="document.getElementById('profileModal').classList.remove('is-active');">Close</button>
                </footer>
            </div>
        </div>
        <script>
            // Listen for profile switches from profileManager.js
            document.body.addEventListener('profileSwitched', (event) => {
                window.globalActiveProfileId = localStorage.getItem('activeProfileId');
                console.log('Profile switched event received. New globalActiveProfileId:', window.globalActiveProfileId);
                // Trigger a full page reload or update all relevant HTMX components
                // For simplicity and full refresh of profile-specific data, a reload is best here.
                location.reload();
            });

            // HTMX request interception to inject profileId into URLs
            document.body.addEventListener('htmx:beforeRequest', function (event) {
                let targetUrl = event.detail.path;

                // ADD THIS CHECK: Ensure targetUrl is a string before proceeding
                if (typeof targetUrl !== 'string' || !targetUrl) {
                    return; // Exit the function if targetUrl is invalid
                }

                let newUrl = targetUrl; // Initialize newUrl with targetUrl
                const currentProfileId = window.globalActiveProfileId; // Get the currently active profile ID

                // Skip profile-related API calls that handle profile creation/deletion/switching directly
                // These already include the necessary profile IDs or operate globally.
                if (targetUrl.startsWith('/api/profiles')) {
                    // For example, /api/profiles (GET all), /api/profiles/{id} (DELETE), /api/profiles (POST create)
                    // /api/profiles/current, /api/profiles/switch/{id} are handled by profileManager.js or don't need globalActiveProfileId injected here.
                    return;
                }

                // All other API calls related to music or settings that need profileId
                if (targetUrl.startsWith('/api/music/') || targetUrl.startsWith('/api/settings/')) {
                    const parts = targetUrl.split('/');
                    const module = parts[2]; // 'music' or 'settings'

                    if (module === 'music') {
                        const subModule = parts[3]; // e.g., 'ui', 'playback', 'queue', 'playlists'

                        if (subModule === 'ui') {
                            // Pattern: /api/music/ui/{profileId}/...
                            // Examples: /api/music/ui/playlists-fragment, /api/music/ui/tbody/0, /api/music/ui/search-suggestions
                            // Ensure profileId is inserted right after 'ui'
                            if (parts[4] !== currentProfileId) { // Check if profileId is NOT already correctly placed
                                newUrl = `/api/music/ui/${currentProfileId}` + targetUrl.substring('/api/music/ui'.length);
                            }
                        } else if (subModule === 'playback') {
                            // Pattern: /api/music/playback/{action}/{profileId}/{id?}
                            // Examples: /api/music/playback/queue-all/0, /api/music/playback/select/123, /api/music/playback/toggle
                            const action = parts[4];
                            if (action === 'queue-all' || action === 'select') {
                                // For /api/music/playback/queue-all/{playlistId}, /api/music/playback/select/{songId}
                                // Needs to become /api/music/playback/{action}/{profileId}/{id}
                                newUrl = `/api/music/playback/${action}/${currentProfileId}/${parts[5]}`;
                            } else if (action === 'volume' || action === 'position') {
                                // For /api/music/playback/volume/{level}, /api/music/playback/position/{seconds}
                                // Needs to become /api/music/playback/{action}/{profileId}/{value}
                                newUrl = `/api/music/playback/${action}/${currentProfileId}/${parts[5]}`;
                            } else {
                                // For actions like /api/music/playback/toggle, /api/music/playback/play, /api/music/playback/next, etc.
                                // Needs to become /api/music/playback/{action}/{profileId}
                                if (parts.length < 5 || parts[5] !== currentProfileId) { // If profileId is not appended
                                    newUrl = `${targetUrl}/${currentProfileId}`;
                                }
                            }
                        } else if (subModule === 'queue') {
                            // Pattern: /api/music/queue/{profileId}/{action}/{id?}
                            // Examples: /api/music/queue/add/{songId}, /api/music/queue/skip-to/{index}, /api/music/queue/clear
                            const action = parts[4];
                            if (action === 'add' || action === 'skip-to' || action === 'remove') {
                                // /api/music/queue/{action}/{songId/index} -> /api/music/queue/{action}/{profileId}/{songId/index}
                                newUrl = `/api/music/queue/${action}/${currentProfileId}/${parts[5]}`;
                            } else if (action === 'clear') {
                                // /api/music/queue/clear -> /api/music/queue/clear/{profileId}
                                newUrl = `/api/music/queue/clear/${currentProfileId}`;
                            } else if (parts.length === 4) { // This is likely /api/music/queue (GET current queue for profile)
                                newUrl = `/api/music/queue/${currentProfileId}`;
                            }
                        } else if (subModule === 'playlists') {
                            // Pattern: /api/music/playlists/{playlistId}/songs/{songId}/toggle/{profileId}
                            // Only handles the specific toggle case where profileId is at the end.
                            // Other playlist APIs (create, delete, get playlists themselves) might be global or handled differently.
                            if (parts.length >= 7 && parts[6] === 'toggle') { // Check if it's the toggle action
                                if (parts.length < 8 || parts[7] !== currentProfileId) { // Check if profileId is not appended
                                    newUrl = `${targetUrl}/${currentProfileId}`;
                                }
                            }
                        }
                    } else if (module === 'settings' && parts[3] === 'clearPlaybackHistory') {
                        // Pattern: /api/settings/clearPlaybackHistory/{profileId}
                        if (parts.length < 5 || parts[4] !== currentProfileId) { // If profileId is not appended
                            newUrl = `${targetUrl}/${currentProfileId}`;
                        }
                    }
                }
                if (newUrl !== targetUrl) {
                    event.detail.path = newUrl;
                    console.log('HTMX Request URL modified to:', event.detail.path);
                }
            });

            document.addEventListener('DOMContentLoaded', function () {
                const globalSearchInput = document.querySelector('input[name="search"]');
                const globalSearchDropdown = document.getElementById('globalSearchDropdown');

                function showDropdown() {
                    if (globalSearchInput.value.trim() !== '' && globalSearchDropdown.querySelector('.dropdown-item, .htmx-indicator')) {
                        globalSearchDropdown.style.display = 'block';
                    } else {
                        globalSearchDropdown.style.display = 'none';
                    }
                }

                function hideDropdown() {
                    setTimeout(() => {
                        if (!globalSearchInput.matches(':focus')) {
                            globalSearchDropdown.style.display = 'none';
                        }
                    }, 100);
                }

                if (globalSearchInput && globalSearchDropdown) {
                    globalSearchInput.addEventListener('focus', showDropdown);
                    globalSearchInput.addEventListener('keyup', showDropdown);
                    globalSearchInput.addEventListener('blur', hideDropdown);

                    globalSearchDropdown.addEventListener('mousedown', (event) => {
                        event.preventDefault();
                    });
                }

                document.body.addEventListener('click', function (event) {
                    if (event.target.closest('#clearSearchIcon')) {
                        handleClearGlobalSearch();
                    }
                });

                function handleClearGlobalSearch() {
                    const globalSearchInput = document.querySelector('input[name="search"]');
                    const globalSearchDropdown = document.getElementById('globalSearchDropdown');

                    if (globalSearchInput) {
                        globalSearchInput.value = '';
                        if (globalSearchDropdown) {
                            globalSearchDropdown.style.display = 'none';
                        }
                    }
                }

                document.body.addEventListener('htmx:afterSwap', function (event) {
                    if (event.detail.target.closest('#globalSearchDropdown .dropdown-content')) {
                        showDropdown();
                    }
                });

                const urlParams = new URLSearchParams(window.location.search);
                const searchQuery = urlParams.get('q');
                if (searchQuery && globalSearchInput) {
                    globalSearchInput.value = decodeURIComponent(searchQuery);
                    htmx.trigger(globalSearchInput, 'search');
                    history.replaceState(null, '', window.location.pathname);
                }
            });
        </script>