<div class="player-container">
    <!-- Video.js Player -->
    <div class="video-wrapper">
        <video
            id="videoPlayer"
            class="video-js vjs-default-skin vjs-big-play-centered"
            controls
            preload="auto"
            data-setup='{}'
            width="100%"
            height="100%">
            <source src="/api/video/stream/{item.id}" type="video/mp4">
            Your browser does not support the video tag.
        </video>
    </div>

    <!-- Media Info -->
    <div id="mediaInfo" class="media-info">
        <div class="info-title">{item.title ?: item.seriesTitle}</div>
        <div class="info-meta">
            {#if item.type == 'Episode'}
            S{item.seasonNumber}E{item.episodeNumber}: {item.episodeTitle ?: 'Untitled Episode'}
            {#else}
            {item.title}
            {/if}
            • {item.releaseYear ?: '2024'} • {formatDuration(item.durationSeconds)}
        </div>
    </div>

    <!-- Subtitle Controls -->
    <div class="subtitle-controls">
        <!-- Include subtitle track selector component -->
        <div id="subtitleTrackSelectorContainer"></div>
        
        <!-- Settings button -->
        <button class="subtitle-settings-btn" onclick="toggleSubtitleSettings()" title="Subtitle Settings">
            <i class="pi pi-cog"></i>
        </button>
    </div>

    <!-- Close Button -->
    <button class="close-button" onclick="window.switchSection('details')">
        <i class="pi pi-times"></i>
    </button>
</div>

<script>
    let player = null;
    let currentVideoId = null;

    // Initialize Video.js player
    function initializePlayer() {
        currentVideoId = {item.id};
        
        player = videojs('videoPlayer', {
            controls: true,
            autoplay: true,
            preload: 'auto',
            fluid: true,
            responsive: true,
            playbackRates: [0.5, 1, 1.25, 1.5, 2],
            plugins: {},
            html5: {
                vhs: {
                    overrideNative: true
                }
            }
        });

        // Remove loading overlay when ready
        player.ready(() => {
            document.getElementById('loadingOverlay')?.classList.add('hidden');
            showMediaInfo();
            loadSubtitleTracks();
        });

        // Handle errors
        player.on('error', () => {
            document.getElementById('loadingOverlay')?.classList.add('hidden');
            document.getElementById('errorOverlay')?.classList.add('show');
        });

        // Show media info briefly on play
        player.on('play', () => {
            showMediaInfo();
        });

        // Keyboard controls
        document.addEventListener('keydown', handleKeyPress);

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (player) {
                player.dispose();
            }
        });
    }

    // Load subtitle tracks for the current video
    async function loadSubtitleTracks() {
        try {
            const userId = getCurrentUserId();
            const response = await fetch(`/api/video/subtitles/${currentVideoId}`, {
                method: 'GET',
                headers: userId ? { 'X-User-ID': userId } : {}
            });
            
            if (!response.ok) {
                console.warn('Failed to load subtitle tracks');
                return;
            }
            
            const data = await response.json();
            const tracks = data.tracks || [];
            
            // Clear existing text tracks
            const existingTracks = player.textTracks();
            for (let i = existingTracks.length - 1; i >= 0; i--) {
                player.removeRemoteTextTrack(existingTracks[i]);
            }
            
            // Add subtitle tracks to player
            tracks.forEach((track, index) => {
                const trackElement = {
                    kind: 'subtitles',
                    label: track.displayName || track.languageName,
                    language: track.languageCode,
                    src: `/api/video/subtitles/track/${track.id}`,
                    default: track.isDefault || index === 0
                };
                
                player.addRemoteTextTrack(trackElement, false);
            });
            
            // Enable the subtitle menu if tracks are available
            if (tracks.length > 0) {
                player.controlBar.subtitlesButton.show();
            }
            
        } catch (error) {
            console.error('Error loading subtitle tracks:', error);
        }
    }
    
    // Get current user ID (this should be available from the session/auth system)
    function getCurrentUserId() {
        // This is a placeholder - implement based on your auth system
        return window.currentUserId || null;
    }

    // Show media info
    function showMediaInfo() {
        const info = document.getElementById('mediaInfo');
        if (info) {
            info.classList.add('show');
            setTimeout(() => {
                info.classList.remove('show');
            }, 3000);
        }
    }

    // Keyboard controls
    function handleKeyPress(e) {
        if (!player) return;
        
        switch(e.key) {
            case ' ':
                e.preventDefault();
                if (player.paused()) {
                    player.play();
                } else {
                    player.pause();
                }
                break;
            case 'ArrowLeft':
                e.preventDefault();
                player.currentTime(player.currentTime() - 10);
                break;
            case 'ArrowRight':
                e.preventDefault();
                player.currentTime(player.currentTime() + 10);
                break;
            case 'f':
                e.preventDefault();
                if (player.isFullscreen()) {
                    player.exitFullscreen();
                } else {
                    player.requestFullscreen();
                }
                break;
            case 'm':
                e.preventDefault();
                player.muted(!player.muted());
                break;
            case 'c':
                e.preventDefault();
                toggleSubtitles();
                break;
            case 'Escape':
                e.preventDefault();
                window.switchSection('details');
                break;
        }
    }
    
    // Toggle subtitle visibility
    function toggleSubtitles() {
        const tracks = player.textTracks();
        let hasEnabledSubtitle = false;
        
        // Check if any subtitle track is enabled
        for (let i = 0; i < tracks.length; i++) {
            if (tracks[i].kind === 'subtitles' && tracks[i].mode === 'showing') {
                tracks[i].mode = 'hidden';
                hasEnabledSubtitle = true;
                break;
            }
        }
        
        // If no subtitle was enabled, enable the first one
        if (!hasEnabledSubtitle) {
            for (let i = 0; i < tracks.length; i++) {
                if (tracks[i].kind === 'subtitles') {
                    tracks[i].mode = 'showing';
                    break;
                }
            }
        }
    }

    // Format duration
    function formatDuration(seconds) {
        if (!seconds) return '0m';
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        return hours > 0 ? `${hours}h ${minutes}m` : `${minutes}m`;
    }

    // Load subtitle components
    async function loadSubtitleComponents() {
        try {
            // Load subtitle track selector
            const selectorResponse = await fetch('/templates/subtitleTrackSelector.html');
            if (selectorResponse.ok) {
                const selectorHtml = await selectorResponse.text();
                document.getElementById('subtitleTrackSelectorContainer').innerHTML = selectorHtml;
            }
            
            // Load subtitle settings panel
            const settingsResponse = await fetch('/templates/subtitleSettingsComponent.html');
            if (settingsResponse.ok) {
                const settingsHtml = await settingsResponse.text();
                const settingsDiv = document.createElement('div');
                settingsDiv.innerHTML = settingsHtml;
                document.body.appendChild(settingsDiv);
            }
        } catch (error) {
            console.error('Error loading subtitle components:', error);
        }
    }

    // Initialize on load
    document.addEventListener('DOMContentLoaded', function() {
        initializePlayer();
        loadSubtitleComponents();
    });
</script>

<style>
    .video-wrapper {
        position: relative;
        width: 100%;
        max-width: 100%;
        background: #000;
        border-radius: 8px;
        overflow: hidden;
    }

    .video-js {
        width: 100%;
        height: 60vh;
        min-height: 400px;
    }

    .media-info {
        position: absolute;
        top: 20px;
        left: 20px;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 15px 20px;
        border-radius: 8px;
        opacity: 0;
        transition: opacity 0.3s ease;
        z-index: 10;
        backdrop-filter: blur(10px);
    }

    .media-info.show {
        opacity: 1;
    }

    .info-title {
        font-size: 1.2rem;
        font-weight: 600;
        margin-bottom: 5px;
    }

    .info-meta {
        font-size: 0.9rem;
        opacity: 0.8;
    }

    .close-button {
        position: absolute;
        top: 20px;
        right: 20px;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        border: none;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        z-index: 10;
        transition: background-color 0.3s ease;
        backdrop-filter: blur(10px);
    }

    .close-button:hover {
        background: rgba(255, 255, 255, 0.2);
    }

    .player-container {
        position: relative;
        width: 100%;
        max-width: 100%;
    }

    /* Video.js customization */
    .video-js .vjs-big-play-button {
        font-size: 3em;
        line-height: 1.5;
        height: 1.5em;
        width: 3em;
        border-radius: 50%;
        background: rgba(0, 0, 0, 0.5);
        border: 0.1em solid rgba(255, 255, 255, 0.3);
        color: #fff;
    }

    .video-js .vjs-control-bar {
        background: linear-gradient(transparent, rgba(0, 0, 0, 0.7));
        backdrop-filter: blur(10px);
    }

    .video-js .vjs-play-progress {
        background: #3273dc;
    }

    .video-js .vjs-volume-level {
        background: #3273dc;
    }

    /* Subtitle Controls */
    .subtitle-controls {
        position: absolute;
        top: 20px;
        left: 20px;
        display: flex;
        align-items: center;
        gap: 8px;
        z-index: 10;
    }

    .subtitle-settings-btn {
        background: rgba(0, 0, 0, 0.8);
        color: white;
        border: none;
        border-radius: 6px;
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        z-index: 10;
        transition: background-color 0.3s ease;
        backdrop-filter: blur(10px);
    }

    .subtitle-settings-btn:hover {
        background: rgba(255, 255, 255, 0.2);
    }

    /* Move media info to accommodate subtitle controls */
    .media-info {
        top: 70px; /* Moved down from 20px */
    }
</style>