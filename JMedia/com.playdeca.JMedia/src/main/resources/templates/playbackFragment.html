<div class="player-container">
    <!-- Video.js Player -->
    <div class="video-wrapper">
        <video
            id="videoPlayer"
            class="video-js vjs-default-skin vjs-big-play-centered"
            controls
            preload="auto"
            data-setup='{}'
            width="100%"
            height="100%">
            <source src="/api/video/stream/{item.id}" type="video/mp4">
            Your browser does not support the video tag.
        </video>
    </div>

    <!-- Media Info -->
    <div id="mediaInfo" class="media-info">
        <div class="info-title">{item.title ?: item.seriesTitle}</div>
        <div class="info-meta">
            {#if item.type == 'Episode'}
            S{item.seasonNumber}E{item.episodeNumber}: {item.episodeTitle ?: 'Untitled Episode'}
            {#else}
            {item.title}
            {/if}
            • {item.releaseYear ?: '2024'} • {formatDuration(item.durationSeconds)}
        </div>
    </div>

    <!-- Close Button -->
    <button class="close-button" onclick="window.switchSection('details')">
        <i class="pi pi-times"></i>
    </button>
</div>

<script>
    let player = null;

    // Initialize Video.js player
    function initializePlayer() {
        player = videojs('videoPlayer', {
            controls: true,
            autoplay: true,
            preload: 'auto',
            fluid: true,
            responsive: true,
            playbackRates: [0.5, 1, 1.25, 1.5, 2],
            plugins: {},
            html5: {
                vhs: {
                    overrideNative: true
                }
            }
        });

        // Remove loading overlay when ready
        player.ready(() => {
            document.getElementById('loadingOverlay')?.classList.add('hidden');
            showMediaInfo();
        });

        // Handle errors
        player.on('error', () => {
            document.getElementById('loadingOverlay')?.classList.add('hidden');
            document.getElementById('errorOverlay')?.classList.add('show');
        });

        // Show media info briefly on play
        player.on('play', () => {
            showMediaInfo();
        });

        // Keyboard controls
        document.addEventListener('keydown', handleKeyPress);

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (player) {
                player.dispose();
            }
        });
    }

    // Show media info
    function showMediaInfo() {
        const info = document.getElementById('mediaInfo');
        if (info) {
            info.classList.add('show');
            setTimeout(() => {
                info.classList.remove('show');
            }, 3000);
        }
    }

    // Keyboard controls
    function handleKeyPress(e) {
        if (!player) return;
        
        switch(e.key) {
            case ' ':
                e.preventDefault();
                if (player.paused()) {
                    player.play();
                } else {
                    player.pause();
                }
                break;
            case 'ArrowLeft':
                e.preventDefault();
                player.currentTime(player.currentTime() - 10);
                break;
            case 'ArrowRight':
                e.preventDefault();
                player.currentTime(player.currentTime() + 10);
                break;
            case 'f':
                e.preventDefault();
                if (player.isFullscreen()) {
                    player.exitFullscreen();
                } else {
                    player.requestFullscreen();
                }
                break;
            case 'm':
                e.preventDefault();
                player.muted(!player.muted());
                break;
            case 'Escape':
                e.preventDefault();
                window.switchSection('details');
                break;
        }
    }

    // Format duration
    function formatDuration(seconds) {
        if (!seconds) return '0m';
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        return hours > 0 ? `${hours}h ${minutes}m` : `${minutes}m`;
    }

    // Initialize on load
    document.addEventListener('DOMContentLoaded', initializePlayer);
</script>

<style>
    .video-wrapper {
        position: relative;
        width: 100%;
        max-width: 100%;
        background: #000;
        border-radius: 8px;
        overflow: hidden;
    }

    .video-js {
        width: 100%;
        height: 60vh;
        min-height: 400px;
    }

    .media-info {
        position: absolute;
        top: 20px;
        left: 20px;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 15px 20px;
        border-radius: 8px;
        opacity: 0;
        transition: opacity 0.3s ease;
        z-index: 10;
        backdrop-filter: blur(10px);
    }

    .media-info.show {
        opacity: 1;
    }

    .info-title {
        font-size: 1.2rem;
        font-weight: 600;
        margin-bottom: 5px;
    }

    .info-meta {
        font-size: 0.9rem;
        opacity: 0.8;
    }

    .close-button {
        position: absolute;
        top: 20px;
        right: 20px;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        border: none;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        z-index: 10;
        transition: background-color 0.3s ease;
        backdrop-filter: blur(10px);
    }

    .close-button:hover {
        background: rgba(255, 255, 255, 0.2);
    }

    .player-container {
        position: relative;
        width: 100%;
        max-width: 100%;
    }

    /* Video.js customization */
    .video-js .vjs-big-play-button {
        font-size: 3em;
        line-height: 1.5;
        height: 1.5em;
        width: 3em;
        border-radius: 50%;
        background: rgba(0, 0, 0, 0.5);
        border: 0.1em solid rgba(255, 255, 255, 0.3);
        color: #fff;
    }

    .video-js .vjs-control-bar {
        background: linear-gradient(transparent, rgba(0, 0, 0, 0.7));
        backdrop-filter: blur(10px);
    }

    .video-js .vjs-play-progress {
        background: #3273dc;
    }

    .video-js .vjs-volume-level {
        background: #3273dc;
    }
</style>