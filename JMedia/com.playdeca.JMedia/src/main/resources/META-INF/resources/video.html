<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title id="pageTitle">JMedia Videos</title>

        <script src="/js/theme-initializer.js"></script>
        
        <!-- Alpine.js -->
        <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
        <script>
            document.addEventListener('alpine:init', () => {
                Alpine.store('profile', {
                    currentProfile: null
                });
            });
        </script>

        <!-- Bulma CSS -->
        <link rel="stylesheet" href="/css/bulma.min.css"/>
        <link rel="stylesheet" href="https://unpkg.com/primeicons@7.0.0/primeicons.css">
        <link rel="stylesheet" href="/css/custom.css"/>

        <link id="favicon" rel="icon" type="image/x-icon" href="logo.png">

    </head>
    <body class="video-page">

        <!-- Hero layout -->
        <section class="hero is-fullheight">

            <!-- Hero Head (Navbar) -->
            <div class="hero-head">
                <nav class="navbar" role="navigation">
                    <div class="navbar-brand">
                        <a class="navbar-item" href="/index.html"><span class="icon"><i class="pi pi-home"></i></span><strong>JMedia</strong></a>
                        <a role="button" class="navbar-item" id="themeToggle">
                            <i class="pi pi-sun" id="themeIcon"></i>
                        </a>
                        <a role="button" class="navbar-item" id="playerToggle">
                            <i class="pi pi-expand" id="playerIcon"></i>
                        </a>
                        <a role="button" class="navbar-item" href="/video.html">
                            <i class="pi pi-video"></i>
                        </a>
                        <a role="button" class="navbar-burger" aria-label="menu" aria-expanded="false" data-target="navMenu">
                            <span aria-hidden="true"></span>
                            <span aria-hidden="true"></span>
                            <span aria-hidden="true"></span>
                        </a>
                        <a role="button" class="navbar-item is-hidden-desktop is-hidden-mobile" id="sidebarToggle">
                            <i class="pi pi-bars"></i>
                        </a>
                    </div>
                    <div id="navMenu" class="navbar-menu">
                        <div class="navbar-start">
                        </div>
                        <div class="navbar-item is-expanded" style="justify-content: center;">
                            <div class="navbar-search-container">
                                <div class="control has-icons-right" style="flex-grow: 1;">
                                    <input class="input is-rounded" type="text" placeholder="Search all videos..." name="search" id="globalSearchInput"
                                           hx-get="/api/video/ui/tbody/{profileId}/0"
                                           hx-trigger="search, keyup changed delay:500ms from:this"
                                           hx-target="#videoTableBody"
                                           hx-swap="innerHTML"
                                           hx-include="[name='search']"
                                           hx-indicator="#loadingRow">
                                    <span class="icon is-small is-right is-clickable" id="clearSearchIcon" style="pointer-events: auto;">
                                        <i class="pi pi-times"></i>
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="navbar-end">
                            <a class="navbar-item" id="openProfileModalBtn">
                                <span class="icon"><i class="pi pi-user"></i></span>
                                <span id="currentProfileName">Loading...</span>
                            </a>
                            <a class="navbar-item" href="/settings.html">
                                <span class="icon"><i class="pi pi-cog"></i></span>
                                <span>Settings</span>
                            </a>
                        </div>
                    </div>
                </nav>
            </div>

            <!-- Hero Body (SPA Content) -->
            <div class="hero-body">
                <div id="spa-container" class="spa-container">
                    <!-- Loading State -->
                    <div id="loading-state" class="loading-overlay" style="display: none;">
                        <div class="loading-content">
                            <i class="pi pi-spin pi-spinner" style="font-size: 2rem;"></i>
                            <span class="loading-text">Loading content...</span>
                        </div>
                    </div>
                    
                    <!-- Content Container -->
                    <div id="spa-content" class="spa-content">
                        <!-- Dynamic content will be loaded here -->
                        <div class="has-text-centered py-4">
                            <i class="pi pi-spin pi-spinner" style="font-size: 2rem;"></i>
                            <p>Loading video content...</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <script src="/js/navbar.js"></script>
        <script src="/js/profileManager.js"></script>
        <script src="/js/videoContextMenu.js"></script>
        <script>
            // Define globalActiveProfileId as a property of the window object
            window.globalActiveProfileId = localStorage.getItem('activeProfileId') || '1';
        </script>
        
        <!-- SPA JavaScript -->
        <script>
            class VideoSPA {
                constructor() {
                    this.currentSection = 'carousels';
                    this.currentVideo = null;
                    this.isLoading = false;
                    this.sections = {
                        carousels: '/api/video/ui/carousels-fragment',
                        details: '/api/video/ui/details-fragment/{videoId}',
                        playback: '/api/video/ui/playback-fragment'
                    };
                }
                
                async switchSection(section, params = {}) {
                    this.showLoading();
                    const url = this.buildUrl(section, params);
                    try {
                        const html = await this.fetchContent(url);
                        this.updateContent(html);
                        this.hideLoading(); // Hide loading after successful content update
                        this.currentSection = section;
                        this.updateNavState(section);
                    } catch (error) {
                        this.handleError(error);
                    }
                }
                
                async selectItem(item, action) {
                    switch(action) {
                        case 'play':
                            await this.playVideo(item);
                            break;
                        case 'details':
                            await this.switchSection('details', {videoId: item.id});
                            break;
                        case 'queue-add':
                            await this.addToQueue(item.id);
                            break;
                    }
                }
                
                async playVideo(item) {
                    // Update playback state via API
                    await fetch('/api/video/playback/play/' + item.id, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    // Switch to playback view
                    await this.switchSection('playback', {videoId: item.id});
                }
                
                async addToQueue(videoId) {
                    try {
                        const response = await fetch('/api/video/queue/add/' + videoId, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        });
                        if (response.ok) {
                            console.log('Added to queue:', videoId);
                        }
                    } catch (error) {
                        console.error('Failed to add to queue:', error);
                    }
                }
                
                buildUrl(section, params) {
                    let url = this.sections[section] || section;
                    for (const [key, value] of Object.entries(params)) {
                        url = url.replace('{' + key + '}', value);
                    }
                    return url;
                }
                
                async fetchContent(url) {
                    const response = await fetch(url);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return await response.text();
                }
                
                updateContent(html) {
                    const contentDiv = document.getElementById('spa-content');
                    if (contentDiv) {
                        contentDiv.innerHTML = html;
                        
                        // Execute any scripts in the new content
                        const scripts = contentDiv.querySelectorAll('script');
                        scripts.forEach(script => {
                            const newScript = document.createElement('script');
                            if (script.src) {
                                newScript.src = script.src;
                            } else {
                                newScript.textContent = script.textContent;
                            }
                            document.head.appendChild(newScript);
                            document.head.removeChild(newScript);
                        });
                    }
                }
                
                showLoading() {
                    this.isLoading = true;
                    const loadingDiv = document.getElementById('loading-state');
                    const contentDiv = document.getElementById('spa-content');
                    if (loadingDiv) loadingDiv.style.display = 'flex';
                    if (contentDiv) contentDiv.style.opacity = '0.3';
                }
                
                hideLoading() {
                    this.isLoading = false;
                    const loadingDiv = document.getElementById('loading-state');
                    const contentDiv = document.getElementById('spa-content');
                    if (loadingDiv) loadingDiv.style.display = 'none';
                    if (contentDiv) contentDiv.style.opacity = '1';
                }
                
                handleError(error) {
                    console.error('SPA Error:', error);
                    this.hideLoading();
                    const contentDiv = document.getElementById('spa-content');
                    if (contentDiv) {
                        contentDiv.innerHTML = `
                            <div class="notification is-danger">
                                <strong>Error:</strong> ${error.message}
                                <button class="delete" onclick="this.parentElement.remove()"></button>
                            </div>
                        `;
                    }
                }
                
                updateNavState(section) {
                    // Update navigation active states if needed
                    // This could be expanded to highlight current section in nav
                }
            }

            // Initialize SPA
            const videoSPA = new VideoSPA();

            // Global functions for template compatibility
            window.selectItem = (item, action) => videoSPA.selectItem(item, action);
            window.switchSection = (section, params) => videoSPA.switchSection(section, params);
            window.addToWatchlist = (item) => {
                console.log('Add to watchlist:', item);
                // Implementation would depend on your watchlist system
            };
            window.scrollCarousel = (carouselId, direction) => {
                const carousel = document.getElementById(carouselId);
                if (carousel) {
                    const scrollAmount = 300;
                    carousel.scrollBy({
                        left: scrollAmount * direction,
                        behavior: 'smooth'
                    });
                }
            };

            // Initialize on page load
            document.addEventListener('DOMContentLoaded', () => {
                videoSPA.switchSection('carousels');
            });
        </script>
    
    <!-- Profile Management Modal -->
    <div id="profileModal" class="modal">
      <div class="modal-background" onclick="document.getElementById('profileModal').classList.remove('is-active');"></div>
    <div class="modal-card glass-modal">
      <header class="modal-card-head glass-modal-header">
          <p class="modal-card-title">Manage Profiles</p>
          <button class="delete" aria-label="close" onclick="document.getElementById('profileModal').classList.remove('is-active');"></button>
        </header>
        <section class="modal-card-body glass-modal-body">
          <h5 class="title is-5">Current Profile: <span id="modalCurrentProfileName">Loading...</span></h5>
          <h6 class="title is-6 mt-4">All Profiles:</h6>
          <div class="field is-grouped is-grouped-multiline is-justify-content-center" id="profileList">
            <!-- Profiles will be dynamically loaded here as circular buttons -->
          </div>
          <hr>
          <div class="field has-addons">
              <div class="control is-expanded">
                  <input class="input" type="text" id="newProfileNameInput" placeholder="New Profile Name">
              </div>
              <div class="control">
                  <button class="button is-info" id="createProfileBtn">Create</button>
              </div>
          </div>
          <button class="button is-danger is-fullwidth mt-4" id="deleteCurrentProfileBtn">Delete Current Profile</button>
        </section>
        <footer class="modal-card-foot glass-modal-footer">
          <button class="button" onclick="document.getElementById('profileModal').classList.remove('is-active');">Close</button>
        </footer>
      </div>
    </div>
</body>
</html>