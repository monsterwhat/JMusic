<!DOCTYPE html>
<html lang="en" x-data="{ totalSteps: 4, get currentStep() { return $store.setup.currentStep || 1; } }">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>JMedia - Setup Wizard</title>
        <link rel="stylesheet" href="/css/bulma.min.css">
        <link rel="stylesheet" href="https://unpkg.com/primeicons@7.0.0/primeicons.css">
        <link rel="stylesheet" href="/css/custom.css">
        <script defer src="/js/htmx.min.js"></script>
        <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    
    </head>
    <body class="has-background-light">
        <div class="setup-container">
            <!-- Header -->
            <div class="has-text-centered mb-6">
                <h1 class="title is-2 has-text-white">Welcome to JMedia</h1>
                <p class="subtitle is-5 has-text-white">Your personal music and video library manager</p>
            </div>

            <!-- Progress Bar -->
            <div class="progress-bar">
                <div class="progress-fill" :style="`width: ${($store.setup.currentStep / totalSteps) * 100}%`"></div>
            </div>

            <!-- Step Indicators -->
            <div class="columns is-mobile is-centered mb-6">
                <div class="column is-narrow">
                    <div class="buttons has-addons">
                        <button class="button" :class="{ 'is-primary': $store.setup.currentStep === 1, 'is-success': $store.setup.currentStep > 1 }" disabled>
                            <span class="is-hidden-mobile">Welcome</span>
                        </button>
                        <button class="button" :class="{ 'is-primary': $store.setup.currentStep === 2, 'is-success': $store.setup.currentStep > 2 }" disabled>
                            <span class="is-hidden-mobile">Library</span>
                        </button>
                        <button class="button" :class="{ 'is-primary': $store.setup.currentStep === 3, 'is-success': $store.setup.currentStep > 3 }" disabled>
                            <span class="is-hidden-mobile">Features</span>
                        </button>
                        <button class="button" :class="{ 'is-primary': $store.setup.currentStep === 4 }" disabled>
                            <span class="is-hidden-mobile">Complete</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Steps Container -->
            <div class="steps-container" style="max-height: calc(100vh - 300px); overflow-y: auto;">
                <!-- Step 1: Welcome -->
                <div class="step-content" :class="{ 'active': $store.setup.currentStep === 1 }">
                    <div class="box glass-box welcome-card">
                        <h2 class="title is-4 mb-4">Welcome to JMedia!</h2>

                        <div class="content">
                            <p class="mb-4">
                                JMedia is a free, open-source music and video library manager that helps you organize, 
                                manage, and enjoy your personal media collection.
                            </p>

                            <div class="notification is-info">
                                <strong>Important Notice:</strong>
                                <ul class="mt-2">
                                    <li>JMedia is provided as free, open-source software</li>
                                    <li>No warranties or guarantees are provided</li>
                                    <li>Use at your own discretion</li>
                                    <li>Always backup your media files</li>
                                </ul>
                            </div>

                            <div class="columns is-multiline mt-5">
                                <div class="column is-half">
                                    <div class="card feature-card">
                                        <div class="card-content">
                                            <div class="media">
                                                <div class="media-left">
                                                    <span class="icon is-large has-text-primary">
                                                        <i class="pi pi-music" style="font-size: 2rem;"></i>
                                                    </span>
                                                </div>
                                                <div class="media-content">
                                                    <h3 class="title is-6">Music Management</h3>
                                                    <p class="subtitle is-7">Organize and play your music library</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="column is-half">
                                    <div class="card feature-card">
                                        <div class="card-content">
                                            <div class="media">
                                                <div class="media-left">
                                                    <span class="icon is-large has-text-info">
                                                        <i class="pi pi-video" style="font-size: 2rem;"></i>
                                                    </span>
                                                </div>
                                                <div class="media-content">
                                                    <h3 class="title is-6">Video Management</h3>
                                                    <p class="subtitle is-7">Manage TV shows and movies</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="column is-half">
                                    <div class="card feature-card">
                                        <div class="card-content">
                                            <div class="media">
                                                <div class="media-left">
                                                    <span class="icon is-large has-text-success">
                                                        <i class="pi pi-download" style="font-size: 2rem;"></i>
                                                    </span>
                                                </div>
                                                <div class="media-content">
                                                    <h3 class="title is-6">Import Features</h3>
                                                    <p class="subtitle is-7">Download and organize media</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="column is-half">
                                    <div class="card feature-card">
                                        <div class="card-content">
                                            <div class="media">
                                                <div class="media-left">
                                                    <span class="icon is-large has-text-warning">
                                                        <i class="pi pi-shield" style="font-size: 2rem;"></i>
                                                    </span>
                                                </div>
                                                <div class="media-content">
                                                    <h3 class="title is-6">Privacy First</h3>
                                                    <p class="subtitle is-7">All your data is stored in YOUR computer</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="field is-grouped is-grouped-centered mt-6">
                                <p class="control">
                                    <button class="button is-large is-primary slide-button" @click="$store.setup.nextStep()">
                                        Get Started
                                    </button>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Library Configuration -->
                <div class="step-content" :class="{ 'active': $store.setup.currentStep === 2 }">
                    <div class="box glass-box library-card">
                        <h2 class="title is-4 mb-4">Library Configuration</h2>

                        <div class="content">
                            <p class="mb-4">Select the default folders where your media files will be stored:</p>

                            <!-- Music Library Folder -->
                            <div class="field">
                                <label class="label is-large">Music Library Folder</label>
                                <div class="field has-addons">
                                    <div class="control is-expanded">
                                        <input 
                                            type="text" 
                                            class="input is-large" 
                                            placeholder="Select your music library folder..."
                                            x-model="$store.setup.musicLibraryPath"
                                            readonly>
                                    </div>
                                    <div class="control">
                                        <button class="button is-large is-primary" @click="$store.setup.browseFolder('music')">
                                            <span class="icon">
                                                <i class="pi pi-folder-open"></i>
                                            </span>
                                            Browse
                                        </button>
                                    </div>
                                </div>
                                <p class="help">This folder will contain your organized music collection</p>
                            </div>

                            <!-- Video Library Folder -->
                            <div class="field">
                                <label class="label is-large">Video Library Folder</label>
                                <div class="field has-addons">
                                    <div class="control is-expanded">
                                        <input 
                                            type="text" 
                                            class="input is-large" 
                                            placeholder="Select your video library folder..."
                                            x-model="$store.setup.videoLibraryPath"
                                            readonly>
                                    </div>
                                    <div class="control">
                                        <button class="button is-large is-primary" @click="$store.setup.browseFolder('video')">
                                            <span class="icon">
                                                <i class="pi pi-folder-open"></i>
                                            </span>
                                            Browse
                                        </button>
                                    </div>
                                </div>
                                <p class="help">This folder will contain your TV shows and movies (optional)</p>
                            </div>

                            <!-- Service Mode Toggle -->
                            <div class="field">
                                <label class="label is-large">Service Mode</label>
                                <div class="control">
                                    <label class="checkbox is-large">
                                        <input 
                                            type="checkbox" 
                                            x-model="$store.setup.runAsService">
                                        <strong>Run as Service (Don't close on disconnect)</strong>
                                    </label>
                                </div>
                                <p class="help">Keep JMedia running even when browser is closed. Access it anytime from this computer's IP address or http://localhost</p>
                            </div>
                        </div>
                    </div>

                    <div class="field is-grouped is-grouped-centered mt-6">
                        <p class="control">
                            <button class="button" @click="previousStep()">
                                <span class="icon">
                                    <i class="pi pi-arrow-left"></i>
                                </span>
                                Back
                            </button>
                        </p>
                        <p class="control">
                            <button class="button is-primary" @click="$store.setup.validateAndNext()">
                                Next
                                <span class="icon">
                                    <i class="pi pi-arrow-right"></i>
                                </span>
                            </button>
                        </p>
                    </div>
                </div>
                <!-- Step 3: Features Configuration -->
                <div class="step-content" :class="{ 'active': $store.setup.currentStep === 3 }">
                    <div class="box glass-box">
                        <h2 class="title is-4 mb-4">Features Configuration</h2>

                        <div class="feature-cards-carousel">
                            <!-- Import Installation Card -->
                            <div class="feature-card-slide">
                                <div class="box glass-box library-card">
                                    <h3 class="title is-5 mb-4">Import Installation</h3>

                                    <div class="notification is-warning is-light">
                                        <strong>Import features require additional installations.</strong>
                                        <p class="mb-3">The following components need to be installed to enable music import functionality:</p>
                                        <ul class="mb-4" id="missingComponentsList">
                                            <!-- Components will be dynamically added here -->
                                        </ul>
                                        <p class="is-size-7">Note: On Windows, Chocolatey is installed first, then Python and FFmpeg via Chocolatey, and SpotDL/Whisper via pip (Python).</p>
                                        <div class="mt-3">
                                            <button class="button is-small is-info" @click="$store.setup.checkInstallationStatus()">
                                                <span class="icon">
                                                    <i class="pi pi-refresh"></i>
                                                </span>
                                                Refresh Status
                                            </button>
                                        </div>
                                    </div>

                                    <!-- Chocolatey Installation -->
                                    <div class="field mb-3">
                                        <div class="level is-mobile">
                                            <div class="level-left">
                                                <label class="label mb-0">Chocolatey</label>
                                            </div>
                                            <div class="level-right">
                                                <button id="installChocoBtn" class="button is-success is-rounded is-small" @click="$store.setup.installChoco()">
                                                    <i class="pi pi-download mr-1"></i>
                                                    Install Chocolatey
                                                </button>
                                            </div>
                                        </div>
                                        <div class="mt-2" id="chocoProgressContainer" style="display: none;">
                                            <progress id="chocoInstallProgress" class="progress is-small is-info" value="0" max="100">0%</progress>
                                        </div>
                                        <p id="chocoStatus" class="help is-size-7 mt-2">Not installed</p>
                                    </div>

                                    <!-- Python Installation -->
                                    <div class="field mb-3">
                                        <div class="level is-mobile">
                                            <div class="level-left">
                                                <label class="label mb-0">Python</label>
                                            </div>
                                            <div class="level-right">
                                                <button id="installPythonBtn" class="button is-success is-rounded is-small" @click="$store.setup.installPython()">
                                                    <i class="pi pi-download mr-1"></i>
                                                    Install Python
                                                </button>
                                            </div>
                                        </div>
                                        <div class="mt-2" id="pythonProgressContainer" style="display: none;">
                                            <progress id="pythonInstallProgress" class="progress is-small is-info" value="0" max="100">0%</progress>
                                        </div>
                                        <p id="pythonStatus" class="help is-size-7 mt-2">Not installed</p>
                                    </div>

                                    <!-- FFmpeg Installation -->
                                    <div class="field mb-3">
                                        <div class="level is-mobile">
                                            <div class="level-left">
                                                <label class="label mb-0">FFmpeg</label>
                                            </div>
                                            <div class="level-right">
                                                <button id="installFfmpegBtn" class="button is-success is-rounded is-small" @click="$store.setup.installFfmpeg()">
                                                    <i class="pi pi-download mr-1"></i>
                                                    Install FFmpeg
                                                </button>
                                            </div>
                                        </div>
                                        <div class="mt-2" id="ffmpegProgressContainer" style="display: none;">
                                            <progress id="ffmpegInstallProgress" class="progress is-small is-info" value="0" max="100">0%</progress>
                                        </div>
                                        <p id="ffmpegStatus" class="help is-size-7 mt-2">Not installed</p>
                                    </div>

                                    <!-- SpotDL Installation -->
                                    <div class="field mb-3">
                                        <div class="level is-mobile">
                                            <div class="level-left">
                                                <label class="label mb-0">SpotDL</label>
                                            </div>
                                            <div class="level-right">
                                                <button id="installSpotdlBtn" class="button is-success is-rounded is-small" @click="$store.setup.installSpotdl()">
                                                    <i class="pi pi-download mr-1"></i>
                                                    Install SpotDL
                                                </button>
                                            </div>
                                        </div>
                                        <div class="mt-2" id="spotdlProgressContainer" style="display: none;">
                                            <progress id="spotdlInstallProgress" class="progress is-small is-info" value="0" max="100">0%</progress>
                                        </div>
                                        <p id="spotdlStatus" class="help is-size-7 mt-2">Not installed</p>
                                    </div>

                                    <!-- Whisper Installation -->
                                    <div class="field mb-3">
                                        <div class="level is-mobile">
                                            <div class="level-left">
                                                <label class="label mb-0">Whisper</label>
                                            </div>
                                            <div class="level-right">
                                                <button id="installWhisperBtn" class="button is-success is-rounded is-small" @click="$store.setup.installWhisper()">
                                                    <i class="pi pi-download mr-1"></i>
                                                    Install Whisper
                                                </button>
                                            </div>
                                        </div>
                                        <div class="mt-2" id="whisperProgressContainer" style="display: none;">
                                            <progress id="whisperInstallProgress" class="progress is-small is-info" value="0" max="100">0%</progress>
                                        </div>
                                        <p id="whisperStatus" class="help is-size-7 mt-2">Not installed</p>
                                    </div>

                                    <!-- Import Settings (shown only after SpotDL is installed) -->
                                    <div id="importSettingsSection" style="display: none;" class="mt-5">
                                        <hr class="my-4">
                                        <h4 class="title is-5 mb-4">Import Settings</h4>

                                        <div class="columns">
                                            <div class="column">
                                                <div class="field">
                                                    <label class="label">Output Format</label>
                                                    <div class="control">
                                                        <div class="select is-fullwidth">
                                                            <select id="outputFormat" name="outputFormat" x-model="$store.setup.outputFormat">
                                                                <option value="mp3">MP3</option>
                                                                <option value="flac">FLAC</option>
                                                                <option value="wav">WAV</option>
                                                                <option value="m4a">M4A</option>
                                                            </select>
                                                        </div>
                                                    </div>
                                                    <p class="help">Choose output format for downloaded files</p>
                                                </div>
                                            </div>
                                            <div class="column">
                                                <div class="field">
                                                    <label class="label">Download Threads</label>
                                                    <div class="control">
                                                        <input 
                                                            type="number" 
                                                            class="input" 
                                                            id="downloadThreads"
                                                            name="downloadThreads"
                                                            min="1" 
                                                            max="16"
                                                            x-model="$store.setup.downloadThreads">
                                                    </div>
                                                    <p class="help">Number of concurrent downloads (1-16)</p>
                                                </div>
                                            </div>
                                            <div class="column">
                                                <div class="field">
                                                    <label class="label">Search Threads</label>
                                                    <div class="control">
                                                        <input 
                                                            type="number" 
                                                            class="input" 
                                                            id="searchThreads"
                                                            name="searchThreads"
                                                            min="1" 
                                                            max="16"
                                                            x-model="$store.setup.searchThreads">
                                                    </div>
                                                    <p class="help">Number of concurrent searches (1-16)</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div> 
                                </div> 
                            </div> 
                        </div>

                        <div class="field is-grouped is-grouped-centered mt-6">
                            <p class="control">
                                <button class="button" @click="previousStep()">
                                    <span class="icon">
                                        <i class="pi pi-arrow-left"></i>
                                    </span>
                                    Back
                                </button>
                            </p>
                            <p class="control">
                                <button class="button is-primary" @click="nextStep()">
                                    Next
                                    <span class="icon">
                                        <i class="pi pi-arrow-right"></i>
                                    </span>
                                </button>
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Step 4: Complete -->
                <div class="step-content" :class="{ 'active': $store.setup.currentStep === 4 }">
                    <div class="box glass-box">
                        <h2 class="title is-4 mb-4">Setup Summary</h2>

                        <div class="content">
                            <p>Review your configuration before completing setup:</p>

                            <div class="columns is-multiline">
                                <!-- Library Paths -->
                                <div class="column is-half">
                                    <div class="notification is-info">
                                        <strong>Music Library</strong>
                                        <p x-text="$store.setup.musicLibraryPath || 'Not selected'"></p>
                                    </div>
                                </div>
                                <div class="column is-half" x-show="$store.setup.videoLibraryPath">
                                    <div class="notification is-info">
                                        <strong>Video Library</strong>
                                        <p x-text="$store.setup.videoLibraryPath"></p>
                                    </div>
                                </div>

                                <!-- Import Features -->
                                <div class="column is-half" x-show="$store.setup.outputFormat">
                                    <div class="notification is-success">
                                        <strong>Import Features</strong>
                                        <p>Output Format: <span x-text="$store.setup.outputFormat?.toUpperCase()"></span></p>
                                        <p>Download Threads: <span x-text="$store.setup.downloadThreads"></span></p>
                                        <p>Search Threads: <span x-text="$store.setup.searchThreads"></span></p>
                                    </div>
                                </div>

                                <!-- Music Organization -->
                                <div class="column is-half" x-show="$store.setup.organizeLibrary">
                                    <div class="notification is-success">
                                        <strong>Music Organization</strong>
                                        <p>Auto-organize library is enabled</p>
                                    </div>
                                </div>

                                <!-- Video Library -->
                                <div class="column is-half" x-show="$store.setup.videoLibrary">
                                    <div class="notification is-warning">
                                        <strong>Video Library</strong>
                                        <p>Video management is enabled</p>
                                    </div>
                                </div>

                                <!-- Privacy First -->
                                <div class="column is-half" x-show="$store.setup.privateMode">
                                    <div class="notification is-danger">
                                        <strong>Privacy First</strong>
                                        <p>All your data is stored in YOUR computer</p>
                                    </div>
                                </div>

                                <!-- Service Mode -->
                                <div class="column is-half" x-show="$store.setup.runAsService">
                                    <div class="notification is-info">
                                        <strong>Service Mode</strong>
                                        <p>JMedia will run as a service and stay accessible from this computer's IP address after browser closes</p>
                                    </div>
                                </div>

                                <!-- Stay Up to Date -->
                                <div class="column is-full">
                                    <div class="notification is-info is-light">
                                        <p class="has-text-weight-semibold mb-2">
                                            <span class="icon-text">
                                                <span class="icon"><i class="pi pi-sparkles"></i></span>
                                                <span>Stay Up to Date</span>
                                            </span>
                                        </p>
                                        <p class="is-size-7 mb-3">JMedia automatically checks for updates on startup and daily. You can also manually check for updates using the button in settings.</p>
                                        
                                        <div class="content">
                                            <h6 class="title is-6 mb-2">How Updates Work</h6>
                                            <ol class="is-size-7">
                                                <li>Application checks GitHub releases for newer versions</li>
                                                <li>If an update is found, you'll see a notification</li>
                                                <li>Click the notification to view release notes and download links</li>
                                                <li>Download the appropriate file (.exe for Windows, .jar for other platforms)</li>
                                                <li>Close JMedia, replace the old file, and run the new version</li>
                                            </ol>
                                        </div>
                                        
                                        <div class="notification is-warning is-light">
                                            <p class="is-size-7 mb-0">
                                                <span class="icon-text">
                                                    <span class="icon"><i class="pi pi-exclamation-triangle"></i></span>
                                                    <span>Note: Updates are not downloaded automatically. You need to manually download and install them.</span>
                                                </span>
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="has-text-centered mt-6">
                                <div class="mb-5">
                                    <span class="icon is-large has-text-success">
                                        <i class="pi pi-check-circle" style="font-size: 4rem;"></i>
                                    </span>
                                </div>

                                <h3 class="title is-4 mb-4">Ready to Launch JMedia!</h3>
                                <p class="mb-4">
                                    Your JMedia library is now configured and ready to use.
                                </p>
                            </div>
                        </div>

                        <div class="field is-grouped is-grouped-centered mt-6">
                            <p class="control">
                                <button class="button" @click="previousStep()">
                                    <span class="icon">
                                        <i class="pi pi-arrow-left"></i>
                                    </span>
                                    Back
                                </button>
                            </p>
                            <p class="control">
                                <button class="button is-large is-primary" @click="$store.setup.completeSetup()">
                                    <span class="icon">
                                        <i class="pi pi-rocket"></i>
                                    </span>
                                    Launch JMedia
                                </button>
                            </p>
                        </div>
                    </div>
                </div> 
            </div> <!-- End Steps Container -->

            <!-- Loading Overlay -->
            <div class="modal is-active" x-show="$store.setup.loading" x-cloak>
                <div class="modal-background"></div>
                <div class="modal-card glass-loading-modal">
                    <header class="modal-card-head glass-loading-header">
                        <p class="modal-card-title" x-text="$store.setup.loadingMessage || 'Setting up JMedia...'">Setting up JMedia...</p>
                    </header>
                    <section class="modal-card-body glass-loading-body">
                        <div class="has-text-centered">
                            <div class="glass-loader">
                                <div class="loader-ring"></div>
                                <div class="loader-ring"></div>
                                <div class="loader-ring"></div>
                                <div class="loader-ring"></div>
                            </div>
                            <p class="mt-4 loading-message" x-text="$store.setup.loadingMessage"></p>
                            <div class="loading-hint" x-show="$store.setup.loadingMessage && $store.setup.loadingMessage.includes('folder')">
                                <span class="icon">
                                    <i class="pi pi-info-circle"></i>
                                </span>
                                A folder selection dialog will open. If you don't see it, check behind your browser window.
                            </div>
                        </div>
                    </section>
                </div>
            </div>



            <script>
                // Initialize global profile ID (use default profile 1 for setup)
                window.globalActiveProfileId = 1;

                // Load settings before Alpine initializes to prevent hiding
                (async function loadInitialSettings() {
                    try {
                        const response = await fetch(`/api/settings/${globalActiveProfileId}`);
                        if (response.ok) {
                            const result = await response.json();
                            if (result.data) {
                                // Set initial values to prevent content hiding
                                // Always show import features option, default to enabled if settings exist
                                window.initialSetupData = {
                                    installImportFeatures: result.data.outputFormat !== undefined ? true : false,
                                    outputFormat: result.data.outputFormat || 'mp3',
                                    downloadThreads: result.data.downloadThreads || 4,
                                    searchThreads: result.data.searchThreads || 4
                                };
                            }
                        }
                    } catch (error) {
                        console.error('Error loading initial settings:', error);
                        window.initialSetupData = {
                            installImportFeatures: false,
                            outputFormat: 'mp3',
                            downloadThreads: 4,
                            searchThreads: 4
                        };
                    }
                })();

                // Add slide animation function using Alpine.js
                function nextStep() {
                    // Move to next step - Alpine.js will handle the transitions
                    window.Alpine.store('setup').nextStep();
                }

                function previousStep() {
                    // Move to previous step - Alpine.js will handle the transitions
                    window.Alpine.store('setup').previousStep();
                }

                function completeSetup() {
                    // Complete setup - Alpine.js will handle the process
                    window.Alpine.store('setup').completeSetup();
                }
            </script>
            <script src="/js/setup.js"></script>
    </body>
</html>